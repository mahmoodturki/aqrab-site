<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة تبادل المشاهدات - تشغيل تلقائي حقيقي</title>
    <!-- Bootstrap 5 RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #7209b7;
            --accent: #f72585;
            --gold: #ffd700;
            --dark: #2b2d42;
            --light: #edf2f4;
        }
        body {font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, var(--light), #d9e2ec); color: var(--dark);}
        .navbar {background: linear-gradient(to right, var(--primary), var(--secondary)); box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
        .navbar-brand, .nav-link {color: white !important; font-weight: 600;}
        .card-video {border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 6px 20px rgba(0,0,0,0.08); transition: .3s;}
        .card-video:hover {transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.15);}
        .btn-primary {background: var(--primary); border: none; border-radius: 12px; padding: 10px 24px; font-weight: 600;}
        .btn-secondary {background: var(--secondary); border: none; border-radius: 12px;}
        .btn-accent {background: var(--accent); border: none; border-radius: 12px;}
        .progress {height: 8px; border-radius: 4px; background: #e0e0e0;}
        .progress-bar {background: linear-gradient(to right, var(--primary), var(--secondary));}
        .badge-premium {background: linear-gradient(45deg, var(--gold), #ffb300); color: var(--dark); font-weight: bold; animation: pulse 2s infinite;}
        @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        .toast {border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);}
        .iframe-container {position: relative; width: 100%; height: 0; padding-bottom: 56.25%; background: #000; border-radius: 12px; overflow: hidden;}
        .iframe-container iframe {position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;}
        .special-user {border: 3px solid var(--gold); position: relative;}
        .special-user::after {content: 'Crown'; position: absolute; top: -10px; right: -10px; font-size: 24px; background: var(--gold); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2);}
        .queue-counter {position: fixed; bottom: 20px; left: 20px; background: var(--dark); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1050; display: none;}
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="#">Video Swap Platform</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item"><span id="pointsDisplay" class="nav-link">النقاط: 0</span></li>
                <li class="nav-item"><span id="usernameDisplay" class="nav-link"></span></li>
                <li class="nav-item"><button id="logoutBtn" class="btn btn-outline-light btn-sm d-none">تسجيل الخروج</button></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- Auth -->
    <div id="authSection" class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-5">
                    <h3 class="text-center mb-4">Welcome to Video Swap</h3>
                    <form id="authForm">
                        <div class="mb-3">
                            <label class="form-label">اسم المستخدم</label>
                            <input type="text" id="username" class="form-control form-control-lg" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" id="password" class="form-control form-control-lg" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" id="loginBtn" class="btn btn-primary btn-lg">تسجيل الدخول</button>
                            <button type="button" id="registerBtn" class="btn btn-secondary btn-lg">إنشاء حساب</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="appSection" class="d-none">

        <!-- Add Video -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Add New Video</h5>
                <form id="addVideoForm" class="row g-3">
                    <div class="col-md-6"><input type="url" id="videoUrl" class="form-control" placeholder="رابط يوتيوب" required></div>
                    <div class="col-md-2"><input type="number" id="watchTime" class="form-control" placeholder="دقائق" min="1" value="5" required></div>
                    <div class="col-md-2"><input type="number" id="requiredViews" class="form-control" placeholder="المشاهدات" min="1" value="10" required></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-accent w-100">إضافة</button></div>
                </form>
            </div>
        </div>

        <!-- Auto Play Controls -->
        <div class="text-center mb-4">
            <button id="autoPlayBtn" class="btn btn-success btn-lg">Start Auto Play</button>
            <button id="stopAutoPlayBtn" class="btn btn-danger btn-lg d-none">Stop Auto Play</button>
            <div id="queueCounter" class="queue-counter">المتبقي: <span id="remainingCount">0</span></div>
        </div>

        <!-- Modal Player -->
        <div class="modal fade" id="videoModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 rounded-4 overflow-hidden">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title" id="modalVideoTitle">جاري التحميل...</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="iframe-container">
                            <div id="youtubePlayer"></div>
                        </div>
                        <div class="p-3 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>التقدم:</span>
                                <span id="timerDisplay">00:00 / 00:00</span>
                            </div>
                            <div class="progress"><div id="watchProgress" class="progress-bar" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Videos Grid -->
        <div class="row" id="videosGrid"></div>
    </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // ==================== DATA ====================
    const DB = {
        users: JSON.parse(localStorage.getItem('viewSwapUsers')) || {},
        videos: JSON.parse(localStorage.getItem('viewSwapVideos')) || [],
        watched: JSON.parse(localStorage.getItem('viewSwapWatched')) || {}
    };

    let currentUser = null;
    let player = null;
    let requiredSeconds = 0;
    let watchedSeconds = 0;
    let watchStartTime = 0;
    let timerInterval = null;
    let currentVideo = null;
    let autoPlayQueue = [];
    let isAutoPlaying = false;

    // ==================== UTILS ====================
    const saveDB = () => {
        localStorage.setItem('viewSwapUsers', JSON.stringify(DB.users));
        localStorage.setItem('viewSwapVideos', JSON.stringify(DB.videos));
        localStorage.setItem('viewSwapWatched', JSON.stringify(DB.watched));
    };

    const showToast = (msg) => {
        document.getElementById('toastMessage').textContent = msg;
        new bootstrap.Toast(document.getElementById('notificationToast')).show();
    };

    const updatePoints = () => {
        const pts = DB.users[currentUser]?.points || 0;
        document.getElementById('pointsDisplay').textContent = `النقاط: ${pts.toLocaleString()}`;
    };

    const extractYouTubeID = url => {
        const m = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
        return m ? m[1] : null;
    };

    const fetchMeta = async id => {
        try {
            const r = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
            if (r.ok) { const d = await r.json(); return {title: d.title, thumb: d.thumbnail_url}; }
        } catch {}
        return {title: 'فيديو يوتيوب', thumb: `https://img.youtube.com/vi/${id}/maxresdefault.jpg`};
    };

    // ==================== AUTH ====================
    document.getElementById('loginBtn').onclick = () => {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        if (!u || !p) return showToast('املأ الحقول');
        if (DB.users[u] && DB.users[u].password === p) { currentUser = u; loginSuccess(); }
        else showToast('بيانات خاطئة');
    };

    document.getElementById('registerBtn').onclick = () => {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        if (!u || !p) return showToast('املأ الحقول');
        if (DB.users[u]) return showToast('المستخدم موجود');
        DB.users[u] = {password: p, points: 0, videos: []};
        if (u === 'mahoodturki630') DB.users[u].points = 10000000;
        if (u === 'mahmoodturki633') DB.users[u].points = 100000000;
        saveDB();
        currentUser = u;
        loginSuccess();
        showToast('تم إنشاء الحساب');
    };

    const loginSuccess = () => {
        document.getElementById('authSection').classList.add('d-none');
        document.getElementById('appSection').classList.remove('d-none');
        document.getElementById('usernameDisplay').textContent = currentUser;
        document.getElementById('logoutBtn').classList.remove('d-none');
        updatePoints();
        renderVideos();
        if (!DB.watched[currentUser]) DB.watched[currentUser] = {};
        saveDB();
    };

    document.getElementById('logoutBtn').onclick = () => {
        currentUser = null;
        stopAutoPlay();
        document.getElementById('authSection').classList.remove('d-none');
        document.getElementById('appSection').classList.add('d-none');
        document.getElementById('logoutBtn').classList.add('d-none');
    };

    // ==================== ADD VIDEO ====================
    document.getElementById('addVideoForm').onsubmit = async e => {
        e.preventDefault();
        const url = document.getElementById('videoUrl').value.trim();
        const mins = parseInt(document.getElementById('watchTime').value);
        const req = parseInt(document.getElementById('requiredViews').value);
        const id = extractYouTubeID(url);
        if (!id) return showToast('رابط غير صالح');

        if (DB.videos.some(v => v.id === id && v.owner === currentUser)) return showToast('الفيديو مضاف مسبقاً');

        const meta = await fetchMeta(id);
        const video = {
            id,
            owner: currentUser,
            title: meta.title,
            thumbnail: meta.thumb,
            watchTime: mins * 60,
            requiredViews: req,
            currentViews: 0,
            pointsPerView: Math.floor(mins / 5) * 5
        };
        DB.videos.push(video);
        DB.users[currentUser].videos.push(id);
        saveDB();
        renderVideos();
        showToast('تمت الإضافة');
        e.target.reset();
    };

    // ==================== RENDER VIDEOS ====================
    const renderVideos = () => {
        const grid = document.getElementById('videosGrid');
        grid.innerHTML = '';
        const watched = DB.watched[currentUser] || {};

        DB.videos.forEach(v => {
            const isWatched = watched[v.id];
            const isOwner = v.owner === currentUser;
            const special = ['mahoodturki630','mahmoodturki633'].includes(v.owner);
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-4';
            card.innerHTML = `
                <div class="card card-video h-100 ${special?'special-user':''} ${isOwner?'border-primary':''}">
                    <img src="${v.thumbnail}" class="card-img-top" style="height:200px;object-fit:cover;">
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title text-truncate">${v.title}</h6>
                        <p class="text-muted small"><i class="fas fa-user"></i> ${v.owner} ${special?'<span class="badge badge-premium ms-2">مميز</span>':''}</p>
                        <p class="small"><i class="fas fa-clock"></i> ${v.watchTime/60} د <i class="fas fa-eye"></i> ${v.currentViews}/${v.requiredViews} <i class="fas fa-coins"></i> ${v.pointsPerView}</p>
                        <button class="btn ${isWatched?'btn-secondary':'btn-primary'} mt-auto watch-btn" data-id="${v.id}" ${isWatched||isOwner?'disabled':''}>
                            ${isWatched?'تمت':'مشاهدة'}
                        </button>
                    </div>
                </div>`;
            grid.appendChild(card);
        });

        document.querySelectorAll('.watch-btn').forEach(b => b.onclick = () => {
            const vid = DB.videos.find(x => x.id === b.dataset.id);
            if (vid) startWatching(vid);
        });

        updateQueue();
    };

    // ==================== PLAYER API ====================
    function onYouTubeIframeAPIReady() {
        // سيتم إنشاء الـ player عند الحاجة
    }

    const createPlayer = (videoId) => {
        player = new YT.Player('youtubePlayer', {
            height: '100%',
            width: '100%',
            videoId,
            playerVars: {
                autoplay: 1,
                controls: 0,
                modestbranding: 1,
                rel: 0,
                fs: 0,
                iv_load_policy: 3,
                cc_load_policy: 0
            },
            events: {
                onReady: e => e.target.playVideo(),
                onStateChange: onPlayerStateChange
            }
        });
    };

    const onPlayerStateChange = event => {
        if (!currentVideo) return;

        if (event.data === YT.PlayerState.PLAYING) {
            watchStartTime = Date.now();
            startTimer();
        } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
            stopTimer();
            const elapsed = Math.floor((Date.now() - watchStartTime) / 1000);
            watchedSeconds += elapsed;
        }
    };

    // ==================== WATCH LOGIC ====================
    const startWatching = (video) => {
        currentVideo = video;
        requiredSeconds = video.watchTime;
        watchedSeconds = 0;
        document.getElementById('modalVideoTitle').textContent = video.title;

        // إنشاء الـ player
        document.getElementById('youtubePlayer').innerHTML = '';
        createPlayer(video.id);

        const modal = new bootstrap.Modal(document.getElementById('videoModal'));
        modal.show();
    };

    const startTimer = () => {
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - watchStartTime) / 1000);
            const totalWatched = watchedSeconds + elapsed;
            const percent = Math.min((totalWatched / requiredSeconds) * 100, 100);

            const minE = String(Math.floor(totalWatched / 60)).padStart(2, '0');
            const secE = String(totalWatched % 60).padStart(2, '0');
            const minR = String(Math.floor(requiredSeconds / 60)).padStart(2, '0');
            const secR = String(requiredSeconds % 60).padStart(2, '0');

            document.getElementById('timerDisplay').textContent = `${minE}:${secE} / ${minR}:${secR}`;
            document.getElementById('watchProgress').style.width = percent + '%';

            if (totalWatched >= requiredSeconds) {
                completeWatch();
            }
        }, 500);
    };

    const stopTimer = () => {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
    };

    const completeWatch = () => {
        if (DB.watched[currentUser][currentVideo.id]) return;
        DB.watched[currentUser][currentVideo.id] = true;
        currentVideo.currentViews++;
        const pts = currentVideo.pointsPerView;
        DB.users[currentUser].points = (DB.users[currentUser].points || 0) + pts;
        saveDB();
        updatePoints();
        renderVideos();
        showToast(`+${pts} نقطة!`);

        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('videoModal')).hide();
            cleanupPlayer();
            if (isAutoPlaying) setTimeout(playNext, 800);
        }, 1200);
    };

    const cleanupPlayer = () => {
        stopTimer();
        if (player) { player.destroy(); player = null; }
        currentVideo = null;
        watchedSeconds = 0;
    };

    // ==================== AUTO PLAY ====================
    const updateQueue = () => {
        const watched = DB.watched[currentUser] || {};
        autoPlayQueue = DB.videos.filter(v =>
            v.owner !== currentUser &&
            !watched[v.id] &&
            v.currentViews < v.requiredViews
        );
        document.getElementById('remainingCount').textContent = autoPlayQueue.length;
    };

    document.getElementById('autoPlayBtn').onclick = () => {
        if (autoPlayQueue.length === 0) return showToast('لا توجد فيديوهات متاحة');
        isAutoPlaying = true;
        document.getElementById('autoPlayBtn').classList.add('d-none');
        document.getElementById('stopAutoPlayBtn').classList.remove('d-none');
        document.getElementById('queueCounter').style.display = 'block';
        updateQueue();
        playNext();
    };

    document.getElementById('stopAutoPlayBtn').onclick = stopAutoPlay;

    const playNext = () => {
        if (!isAutoPlaying) return;
        updateQueue();
        if (autoPlayQueue.length === 0) { stopAutoPlay(); showToast('انتهى التشغيل التلقائي'); return; }
        startWatching(autoPlayQueue[0]);
    };

    const stopAutoPlay = () => {
        isAutoPlaying = false;
        document.getElementById('autoPlayBtn').classList.remove('d-none');
        document.getElementById('stopAutoPlayBtn').classList.add('d-none');
        document.getElementById('queueCounter').style.display = 'none';
        cleanupPlayer();
    };

    // ==================== MODAL CLEANUP ====================
    document.getElementById('videoModal').addEventListener('hidden.bs.modal', () => {
        cleanupPlayer();
    });

    // ==================== INIT ====================
    (function () {
        if (DB.videos.length === 0) {
            // يمكن إضافة فيديوهات تجريبية هنا إذا أردت
        }
    })();
</script>
</body>
</html>
