
---

### 3. ملف app.js

```javascript
// زيادة عداد الزوار
function incrementVisitorCount() {
    let count = localStorage.getItem('visitorCount') || 0;
    count = parseInt(count, 10) + 1;
    localStorage.setItem('visitorCount', count);
    document.getElementById('visitorCount').textContent = count;
}

// تحميل عداد الزوار
function loadVisitorCount() {
    let count = localStorage.getItem('visitorCount') || 0;
    document.getElementById('visitorCount').textContent = count;
}

// عرض رسالة نجاح
function showSuccessMessage(message) {
    const successMessage = document.getElementById('successMessage');
    successMessage.textContent = message;
    successMessage.style.display = 'block';
    setTimeout(() => {
        successMessage.style.display = 'none';
    }, 3000);
}

// بيانات المنتجات والمستخدمين
let products = JSON.parse(localStorage.getItem('products')) || [
    {
        id: 1,
        name: "هاتف ذكي",
        description: "هاتف ذكي حديث بشاشة كبيرة وكاميرا متميزة",
        price: 2500,
        image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM0OThEQiIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7Yp9mE2YLYqSDYp9mE2KfYstin2YY8L3RleHQ+PC9zdmc+",
        userId: "demo",
        likes: 5,
        comments: [
            { user: "أحمد", text: "منتج رائع!", date: "2023-10-01" },
            { user: "محمد", text: "أريد شراءه", date: "2023-10-02" }
        ],
        shares: 2,
        likedBy: ["demo"]
    },
    {
        id: 2,
        name: "لابتوب",
        description: "لابتوب قوي مناسب للأعمال والألعاب",
        price: 4500,
        image: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzlCNTlCNiIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7Zh9in2YbZhdmI2KfYr9ipPC90ZXh0Pjwvc3ZnPg==",
        userId: "demo",
        likes: 3,
        comments: [
            { user: "سارة", text: "جيد للعمل", date: "2023-10-03" }
        ],
        shares: 1,
        likedBy: ["demo"]
    }
];

let users = JSON.parse(localStorage.getItem('users')) || {};
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

// DOM Elements
const productsGrid = document.getElementById('productsGrid');
const productModal = document.getElementById('productModal');
const loginModal = document.getElementById('loginModal');
const productForm = document.getElementById('productForm');
const loginForm = document.getElementById('loginForm');
const addProductBtn = document.getElementById('addProductBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const heroLoginBtn = document.getElementById('heroLoginBtn');
const cancelBtn = document.getElementById('cancelBtn');
const cancelLoginBtn = document.getElementById('cancelLoginBtn');
const userGreeting = document.getElementById('userGreeting');
const avatarPreview = document.getElementById('avatarPreview');
const productImagePreview = document.getElementById('productImagePreview');

// Preview avatar image
document.getElementById('avatar').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
            avatarPreview.src = e.target.result;
            avatarPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        avatarPreview.style.display = 'none';
    }
});

// Preview product image
document.getElementById('productImage').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
            productImagePreview.src = e.target.result;
            productImagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        productImagePreview.style.display = 'none';
    }
});

// Render products list
function renderProducts() {
    productsGrid.innerHTML = '';

    if (products.length === 0) {
        productsGrid.innerHTML = '<p style="text-align:center; grid-column:1/-1; padding:20px;">لا توجد منتجات لعرضها</p>';
        return;
    }

    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'card';
        productCard.tabIndex = 0;
        productCard.setAttribute('aria-label', `منتج: ${product.name}, السعر: ${product.price} ريال`);

        // Check if current user liked product
        const isLiked = currentUser && product.likedBy && product.likedBy.includes(currentUser.username);

        productCard.innerHTML = `
            <div class="card-img">
                <img src="${product.image}" alt="صورة المنتج ${product.name}" loading="lazy" />
            </div>
            <div class="card-content">
                <h3>${product.name}</h3>
                <p>${product.description}</p>
                <div class="card-price">${product.price} ريال</div>
                <div class="card-actions">
                    <button class="card-btn" type="button" aria-label="عرض المنتج ${product.name}" onclick="viewProduct(${product.id})">عرض</button>
                    <button class="card-btn primary" type="button" aria-label="شراء المنتج ${product.name}" onclick="addToCart(${product.id})">شراء</button>
                </div>
                <div class="interactions">
                    <button class="interaction-btn ${isLiked ? 'active' : ''}" type="button" aria-pressed="${isLiked}" aria-label="${isLiked ? 'إلغاء إعجاب' : 'إعجاب'} بالمنتج ${product.name}" onclick="likeProduct(${product.id})">
                        <i class="fas fa-heart" aria-hidden="true"></i>
                        <span>${product.likes || 0}</span>
                    </button>
                    <button class="interaction-btn" type="button" aria-label="تعليق على المنتج ${product.name}" onclick="commentOnProduct(${product.id})">
                        <i class="fas fa-comment" aria-hidden="true"></i>
                        <span>${product.comments ? product.comments.length : 0}</span>
                    </button>
                    <button class="interaction-btn" type="button" aria-label="مشاركة المنتج ${product.name}" onclick="shareProduct(${product.id})">
                        <i class="fas fa-share" aria-hidden="true"></i>
                        <span>${product.shares || 0}</span>
                    </button>
                </div>
                ${product.comments && product.comments.length > 0 ? `
                <div class="comments-section" aria-label="تعليقات على المنتج ${product.name}">
                    ${product.comments.slice(-2).map(comment => `
                        <div class="comment">
                            <strong>${comment.user}:</strong> ${comment.text}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        `;

        productsGrid.appendChild(productCard);
    });

    localStorage.setItem('products', JSON.stringify(products));
}

// Update UI based on login status
function updateUI() {
    if (currentUser) {
        userGreeting.textContent = `مرحباً، ${currentUser.username}`;
        loginBtn.style.display = 'none';
        addProductBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'inline-block';
        heroLoginBtn.style.display = 'none';
    } else {
        userGreeting.textContent = 'مرحباً، زائر';
        loginBtn.style.display = 'inline-block';
        addProductBtn.style.display = 'none';
        logoutBtn.style.display = 'none';
        heroLoginBtn.style.display = 'inline-block';
    }
}

// Open product modal
addProductBtn.addEventListener('click', () => {
    if (!currentUser) {
        showSuccessMessage('يجب تسجيل الدخول أولاً');
        openModal(loginModal);
        return;
    }
    openModal(productModal);
});

// Open login modal
loginBtn.addEventListener('click', () => openModal(loginModal));
heroLoginBtn.addEventListener('click', () => openModal(loginModal));

// Logout
logoutBtn.addEventListener('click', () => {
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateUI();
    showSuccessMessage('تم تسجيل الخروج بنجاح');
});

// Cancel buttons close modals
cancelBtn.addEventListener('click', () => {
    closeModal(productModal);
    productForm.reset();
    productImagePreview.style.display = 'none';
});
cancelLoginBtn.addEventListener('click', () => {
    closeModal(loginModal);
    loginForm.reset();
    avatarPreview.style.display = 'none';
});

// Close modals when clicking outside content
window.addEventListener('click', (e) => {
    if (e.target === productModal) {
        closeModal(productModal);
        productForm.reset();
        productImagePreview.style.display = 'none';
    }
    if (e.target === loginModal) {
        closeModal(loginModal);
        loginForm.reset();
        avatarPreview.style.display = 'none';
    }
});

// Keyboard accessibility: close modals on Escape key
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (productModal.style.display === 'flex') {
            closeModal(productModal);
            productForm.reset();
            productImagePreview.style.display = 'none';
        }
        if (loginModal.style.display === 'flex') {
            closeModal(loginModal);
            loginForm.reset();
            avatarPreview.style.display = 'none';
        }
    }
});

// Open modal helper
function openModal(modal) {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    // Focus first focusable element inside modal
    const focusable = modal.querySelector('input, button, textarea, select, [tabindex]:not([tabindex="-1"])');
    if (focusable) focusable.focus();
}

// Close modal helper
function closeModal(modal) {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
}

// Login form submit
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const usernameInput = document.getElementById('username');
    const username = usernameInput.value.trim();
    const avatarFile = document.getElementById('avatar').files[0];

    if (!username) {
        showSuccessMessage('يرجى إدخال اسم المستخدم');
        usernameInput.focus();
        return;
    }

    let avatarSrc = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZmZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjgwIiByPSI0MCIgZmlsbD0iIzMzMyIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjIwMCIgcj0iODAiIGZpbGw9IiMzMzMiLz48L3N2Zz4=';

    if (avatarFile && avatarFile.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
            avatarSrc = e.target.result;
            completeLogin(username, avatarSrc);
        };
        reader.readAsDataURL(avatarFile);
    } else {
        completeLogin(username, avatarSrc);
    }
});

function completeLogin(username, avatarSrc) {
    if (!users[username]) {
        users[username] = {
            username: username,
            avatar: avatarSrc,
            joinDate: new Date().toISOString()
        };
        localStorage.setItem('users', JSON.stringify(users));
    }

    currentUser = {
        username: username,
        avatar: users[username].avatar
    };

    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    updateUI();
    closeModal(loginModal);
    loginForm.reset();
    avatarPreview.style.display = 'none';

    showSuccessMessage(`مرحباً ${username}! تم تسجيل الدخول بنجاح.`);
    renderProducts();
}

// Add product form submit
productForm.addEventListener('submit', (e) => {
    e.preventDefault();

    if (!currentUser) {
        showSuccessMessage('يجب تسجيل الدخول أولاً');
        openModal(loginModal);
        return;
    }

    const name = document.getElementById('productName').value.trim();
    const description = document.getElementById('productDescription').value.trim();
    const priceVal = document.getElementById('productPrice').value.trim();
    const price = parseFloat(priceVal);
    const imageFile = document.getElementById('productImage').files[0];

    if (!name) {
        showSuccessMessage('يرجى إدخال اسم المنتج');
        return;
    }
    if (!description) {
        showSuccessMessage('يرجى إدخال وصف المنتج');
        return;
    }
    if (!priceVal || isNaN(price) || price < 0) {
        showSuccessMessage('يرجى إدخال سعر صحيح للمنتج');
        return;
    }
    if (!imageFile || !imageFile.type.startsWith('image/')) {
        showSuccessMessage('يرجى اختيار صورة صحيحة للمنتج');
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        const newProduct = {
            id: Date.now(),
            name,
            description,
            price,
            image: e.target.result,
            userId: currentUser.username,
            likes: 0,
            comments: [],
            shares: 0,
            likedBy: []
        };

        products.push(newProduct);
        localStorage.setItem('products', JSON.stringify(products));
        renderProducts();

        closeModal(productModal);
        productForm.reset();
        productImagePreview.style.display = 'none';

        showSuccessMessage('تم إضافة المنتج بنجاح!');
    };
    reader.readAsDataURL(imageFile);
});

// Like product toggle
function likeProduct(productId) {
    if (!currentUser) {
        showSuccessMessage('يجب تسجيل الدخول أولاً');
        openModal(loginModal);
        return;
    }

    const product = products.find(p => p.id === productId);
    if (!product.likedBy) {
        product.likedBy = [];
    }

    const userIndex = product.likedBy.indexOf(currentUser.username);

    if (userIndex === -1) {
        product.likedBy.push(currentUser.username);
        product.likes = (product.likes || 0) + 1;
        showSuccessMessage('تم الإعجاب بالمنتج!');
    } else {
        product.likedBy.splice(userIndex, 1);
        product.likes = (product.likes || 0) - 1;
        showSuccessMessage('تم إلغاء الإعجاب بالمنتج!');
    }

    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
}

// Comment on product
function commentOnProduct(productId) {
    if (!currentUser) {
        showSuccessMessage('يجب تسجيل الدخول أولاً');
        openModal(loginModal);
        return;
    }

    const comment = prompt('أضف تعليقك على هذا المنتج:');
    if (comment && comment.trim() !== '') {
        const product = products.find(p => p.id === productId);
        if (!product.comments) {
            product.comments = [];
        }

        product.comments.push({
            user: currentUser.username,
            text: comment.trim(),
            date: new Date().toISOString()
        });

        localStorage.setItem('products', JSON.stringify(products));
        renderProducts();
        showSuccessMessage('تم إضافة تعليقك بنجاح!');
    }
}

// Share product
function shareProduct(productId) {
    const product = products.find(p => p.id === productId);
    product.shares = (product.shares || 0) + 1;

    const shareUrl = `${window.location.origin}${window.location.pathname}#product-${productId}`;

    if (navigator.share) {
        navigator.share({
            title: product.name,
            text: product.description,
            url: shareUrl
        })
        .then(() => {
            localStorage.setItem('products', JSON.stringify(products));
            renderProducts();
            showSuccessMessage('تم مشاركة المنتج بنجاح!');
        })
        .catch(() => {
            fallbackShare(shareUrl, product);
        });
    } else {
        fallbackShare(shareUrl, product);
    }
}

// Fallback share by copying link
function fallbackShare(shareUrl, product) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareUrl)
            .then(() => {
                showSuccessMessage(`تم نسخ رابط المنتج: ${product.name}`);
                localStorage.setItem('products', JSON.stringify(products));
                renderProducts();
            })
            .catch(() => {
                showSuccessMessage(`رابط المشاركة: ${shareUrl}`);
                localStorage.setItem('products', JSON.stringify(products));
                renderProducts();
            });
    } else {
        showSuccessMessage(`رابط المشاركة: ${shareUrl}`);
        localStorage.setItem('products', JSON.stringify(products));
        renderProducts();
    }
}

// View product details
function viewProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    alert(`عرض المنتج: ${product.name}\nالسعر: ${product.price} ريال\nالوصف: ${product.description}`);
}

// Add to cart simulation
function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    showSuccessMessage(`تمت إضافة ${product.name} إلى سلة التسوق!`);
}

// Initialization on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    incrementVisitorCount();
    loadVisitorCount();
    renderProducts();
    updateUI();
});
