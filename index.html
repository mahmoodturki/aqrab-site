// server.js (CommonJS)
// Ù†Ø³Ø®Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©: ÙŠØ®Ø¯Ù… ØµÙØ­Ø© HTML Ø¬Ù…ÙŠÙ„Ø© + API ÙŠÙˆØ²Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹.
// Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Node.js Ø¨Ø¯ÙˆÙ† Ø­Ø§Ø¬Ø© Ù„Ù€ "type":"module".

const express = require("express");
const fs = require("fs");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 3000;

// --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Ù…Ø¹Ø±ÙØ§Øª YouTube ÙÙ‚Ø·) ---
const videos = [
  "jEx_rBcE8Bs","oYgr1cemxzU","c3VqnXd3IOY","RD14ZNRCpYI","Q8r0m5WFpvk",
  "pxkp9ehbBkA","QK6rysYv1sM","rYmA9pwKTRs","NcG_PwAFQ3w","uQDG65myVSo",
  "ZxdF8dQ2R6k","j6B8bhXjCHQ","ohLaoKcjY84","NmmKzSOugwA","LFwLfDAnFeY",
  "3qCGFxc2yEg","_JXPY08yg8s","qcAmkjvVcmI"
];

// --- Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ index Ø§Ù„Ø­Ø§Ù„ÙŠ ---
const DATA_FILE = path.join(__dirname, "data.json");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø¨Ø¯Ø£ Ù…Ù† -1
let state = { lastIndex: -1 };
try {
  if (fs.existsSync(DATA_FILE)) {
    const raw = fs.readFileSync(DATA_FILE, "utf8");
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed.lastIndex === "number") state = parsed;
  } else {
    fs.writeFileSync(DATA_FILE, JSON.stringify(state, null, 2));
  }
} catch (err) {
  console.error("Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„/ØªÙ‡ÙŠØ¦Ø© data.json:", err);
}

// --- Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù (Ù…ØªØ²Ø§Ù…Ù†Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨) ---
function saveState() {
  try {
    fs.writeFileSync(DATA_FILE, JSON.stringify(state, null, 2));
  } catch (err) {
    console.error("Ø®Ø·Ø£ Ø¨Ø­ÙØ¸ data.json:", err);
  }
}

// --- Ø®Ø¯Ù…Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù†ÙØ±Ø³Ù„ HTML Ù…Ø¶Ù…Ù†) ---
app.get("/", (req, res) => {
  // ØµÙØ­Ø© HTML Ù…Ø¯Ù…Ø¬Ø©: Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠØŒ Ù…Ø¸Ù„Ù…ØŒ Ø­Ø¬Ù… Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©.
  res.setHeader("Content-Type", "text/html; charset=utf-8");
  res.send(`<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap');
    :root {
      --glass: rgba(255,255,255,0.06);
      --accent: #06b6d4;
      --bg1: #071020;
      --bg2: #001219;
      --text: #e6f7fb;
    }
    html,body { height:100%; margin:0; padding:0; font-family: 'Tajawal', system-ui, sans-serif; background: linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); overflow:hidden; }
    .player-wrapper { position: absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    #player { position:relative; width:100%; height:100%; background:#000; }
    iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }
    .ui {
      position: absolute;
      top: 18px;
      left: 18px;
      display:flex;
      gap:12px;
      align-items:center;
      z-index: 30;
    }
    .brand {
      display:flex;
      gap:10px;
      align-items:center;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:8px 12px;
      border-radius:12px;
      backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,0.03);
    }
    .logo {
      width:42px; height:42px; border-radius:10px; display:grid; place-items:center; background:var(--accent); color:#002;
      font-weight:800; box-shadow: 0 6px 18px rgba(6,182,212,0.12);
    }
    .title { font-weight:700; font-size:15px; }
    .subtitle { font-size:12px; color:#bfeef6; opacity:0.9; margin-top:3px; }
    .controls {
      position: absolute;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap:12px;
      z-index:30;
      align-items:center;
    }
    .btn {
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.04);
      padding:10px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      transition: transform .18s ease, background .18s ease;
      color:var(--text);
      backdrop-filter: blur(6px);
    }
    .btn:hover { transform: translateY(-4px); background: rgba(255,255,255,0.08); }
    .badge {
      position: absolute;
      top: 22px;
      right: 18px;
      background: rgba(0,0,0,0.4);
      padding:8px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.03);
      font-weight:700;
      z-index:30;
      color:#c6f0f7;
    }
    #autoplay-block {
      position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:25;
      background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.65));
      padding:20px;
    }
    #play-interact {
      background:var(--accent); color:#002; border:0; padding:14px 20px; border-radius:999px; font-weight:900; cursor:pointer;
      box-shadow: 0 12px 30px rgba(6,182,212,0.14);
    }
    .small { font-size:13px; color:#bfeef6; opacity:0.95; }
    @media (max-width:700px) {
      .brand .title { font-size:13px; }
      .btn { padding:9px 12px; font-size:14px; }
      .logo { width:36px;height:36px; font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="player-wrapper">
    <div id="player"></div>

    <div class="ui">
      <div class="brand">
        <div class="logo">V</div>
        <div>
          <div class="title">Ù…Ø´ØºÙ„ ÙØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div>
          <div class="subtitle">ÙƒÙ„ Ø²Ø§Ø¦Ø± ÙŠØ±Ù‰ ÙÙŠØ¯ÙŠÙˆ Ù…Ø®ØªÙ„Ù</div>
        </div>
      </div>
    </div>

    <div class="badge" id="statusBadge">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <div id="autoplay-block">
      <div style="text-align:center;">
        <div style="margin-bottom:12px; font-weight:700; font-size:18px; color:#fff">Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø­Ø¸ÙˆØ± â€” Ø§Ø¶ØºØ· Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù„ØµÙˆØª</div>
        <button id="play-interact">ØªØ´ØºÙŠÙ„ + Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…</button>
        <div style="margin-top:10px; color:#bfeef6; opacity:0.9" class="small">ØªÙ„Ù…ÙŠØ­: Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªÙ…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„ØµÙˆØª. Ø§Ù„Ù†Ù‚Ø± ÙŠØ³Ù…Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="muteBtn">ğŸ”‡ ÙƒØªÙ… / ğŸ”Š Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ…</button>
      <button class="btn" id="nextBtn">ğŸ¯ ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø±</button>
      <button class="btn" id="fsBtn">â›¶ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
    </div>
  </div>

  <script>
    // === ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ===
    async function fetchNextVideo() {
      try {
        const res = await fetch("/api/next-video", { cache: "no-store" });
        if (!res.ok) throw new Error("Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
        const data = await res.json();
        return data.videoId;
      } catch (err) {
        console.error("fetchNextVideo error:", err);
        return null;
      }
    }

    // === ØªØ­Ù…ÙŠÙ„ YouTube IFrame API Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ ===
    function loadYouTubeApiOnce() {
      return new Promise((resolve) => {
        if (window.YT && window.YT.Player) return resolve();
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const statusBadge = document.getElementById("statusBadge");
    const autoplayBlock = document.getElementById("autoplay-block");
    const playInteract = document.getElementById("play-interact");
    const muteBtn = document.getElementById("muteBtn");
    const nextBtn = document.getElementById("nextBtn");
    const fsBtn = document.getElementById("fsBtn");

    let player = null;
    let currentVideoId = null;

    async function init() {
      statusBadge.textContent = "Ø¬Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯...";
      const vid = await fetchNextVideo();
      if (!vid) {
        statusBadge.textContent = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ â€” Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.";
        return;
      }
      currentVideoId = vid;
      statusBadge.textContent = "ØªØ­Ù…ÙŠÙ„ Ù…Ø´ØºÙ„ YouTube...";

      await loadYouTubeApiOnce();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„ Ù…ÙƒØªÙˆÙ…Ø§Ù‹ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù€ autoplay
      player = new YT.Player('player', {
        videoId: currentVideoId,
        playerVars: {
          autoplay: 1,
          controls: 1,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          mute: 1
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onStateChange
        }
      });
    }

    function onPlayerReady(event) {
      statusBadge.textContent = "ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¢Ù†";
      // Ù†ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„ Ø¥Ù† Ø´ØºÙ‘Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ù…Ù†Ø¹Ù‘Ù‡ -> Ù†Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙØ§Ø¹Ù„
      setTimeout(() => {
        try {
          const st = event.target.getPlayerState();
          // Ø­Ø§Ù„Ø© 1 = playing
          if (st !== 1) {
            autoplayBlock.style.display = "flex";
          } else {
            autoplayBlock.style.display = "none";
          }
        } catch (e) {
          autoplayBlock.style.display = "flex";
        }
      }, 700);
    }

    function onStateChange(e) {
      if (e.data === YT.PlayerState.ENDED) {
        statusBadge.textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ â€” Ø¬Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ...";
        // Ø¬Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        setTimeout(async () => {
          const nextId = await fetchNextVideo();
          if (nextId && player) {
            currentVideoId = nextId;
            player.loadVideoById(nextId);
            statusBadge.textContent = "ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¢Ù†";
          } else {
            statusBadge.textContent = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ.";
          }
        }, 1200);
      }
    }

    // Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ… ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
    playInteract.addEventListener("click", () => {
      autoplayBlock.style.display = "none";
      if (!player) return;
      try { player.unMute(); } catch(e){}
      try { player.playVideo(); } catch(e){}
    });

    // Ø²Ø± Ø§Ù„ÙƒØªÙ…
    muteBtn.addEventListener("click", () => {
      if (!player) return;
      try {
        if (player.isMuted && player.isMuted()) { player.unMute(); }
        else { player.mute(); }
      } catch (e) { console.error(e); }
    });

    // Ø²Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ (ÙŠØ·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆÙŠØ­Ù…Ù‘Ù„Ù‡ ÙÙˆØ±Ù‹Ø§)
    nextBtn.addEventListener("click", async () => {
      statusBadge.textContent = "Ø¬Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯...";
      const nextId = await fetchNextVideo();
      if (nextId && player) {
        currentVideoId = nextId;
        player.loadVideoById(nextId);
        statusBadge.textContent = "ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¢Ù†";
        window.scrollTo(0,0);
      } else {
        statusBadge.textContent = "ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.";
      }
    });

    // Ø²Ø± Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© (ÙŠØ¯Ø®Ù„ iframe ÙÙŠ ÙˆØ¶Ø¹ full screen)
    fsBtn.addEventListener("click", () => {
      try {
        const iframe = player && player.getIframe ? player.getIframe() : document.querySelector('#player iframe');
        if (!iframe) return;
        if (!document.fullscreenElement) {
          iframe.requestFullscreen?.();
        } else {
          document.exitFullscreen?.();
        }
      } catch (e) { console.error(e); }
    });

    // Ø§Ø¨Ø¯Ø£
    init();
  </script>
</body>
</html>`);
});

// --- API ÙŠØ¹Ø·ÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ Ù„ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© Ø²Ø§Ø¦Ø±Ù‡ Ø¬Ø¯ÙŠØ¯Ø© ---
// ØªØ³Ø¬ÙŠÙ„ Ø¨Ø³ÙŠØ·: ÙƒÙ„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ endpoint ÙŠØ¹ØªØ¨Ø± "Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯" ÙˆÙŠØ¹Ø·Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.
// Ù‡Ø°Ø§ ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.
app.get("/api/next-video", (req, res) => {
  try {
    state.lastIndex = (state.lastIndex + 1) % videos.length;
    saveState();
    const vid = videos[state.lastIndex];
    // Ù†Ø±Ø¬Ø¹ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØªØ§Ø¯Ø§Øª Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù† Ø§Ø­ØªØ¬Ù†Ø§
    res.json({ videoId: vid, index: state.lastIndex, total: videos.length });
  } catch (err) {
    console.error("API error:", err);
    res.status(500).json({ error: "server error" });
  }
});

// --- Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… ---
app.listen(PORT, () => {
  console.log(\`âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ http://localhost:\${PORT}\`);
  console.log("ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");
});
