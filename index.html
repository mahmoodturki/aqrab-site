<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سوشيال نايت — شبكة مشاركة الصور</title>
  <style>
    :root {
      --bg: #05060a;
      --card: #0b1220;
      --muted: #9aa8bf;
      --accent: #06b6d4;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      background: linear-gradient(180deg, #020312 0%, var(--bg) 100%);
      color: #e6eef6;
      scroll-behavior: smooth;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .logo {
      font-weight: 900;
      letter-spacing: 0.6px;
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--accent), #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .container {
      max-width: 980px;
      margin: 18px auto;
      padding: 0 14px;
      padding-bottom: 80px;
    }
    
    .card {
      background: linear-gradient(180deg, var(--card), #081023);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(2,6,23,0.8);
    }
    
    /* أنماط الإعلانات */
    .ad-container {
      margin: 20px 0;
      text-align: center;
      display: flex;
      justify-content: center;
    }
    
    .ad-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    
    .ad-unit {
      margin: 10px auto;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* إعلان ثابت في الأسفل */
    #bottomAd {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(11, 18, 32, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 8px 0;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .ad-close-btn {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .ad-close-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* إعلان جانبي */
    .side-ad {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      z-index: 900;
      background: rgba(11, 18, 32, 0.9);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .side-ad-close {
      position: absolute;
      top: 5px;
      left: 5px;
      background: transparent;
      color: var(--muted);
      border: none;
      cursor: pointer;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .side-ad-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* إعلان بين المنشورات */
    .feed-ad {
      background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(255,255,255,0.05));
      border: 1px solid rgba(6,182,212,0.2);
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .feed-ad-label {
      font-size: 11px;
      color: var(--accent);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    /* بقية الأنماط */
    input, textarea, button, select {
      font-size: 14px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: inherit;
      transition: all 0.2s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6,182,212,0.2);
    }
    
    button {
      cursor: pointer;
      border: 0;
      background: var(--accent);
      color: #001219;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #0891b2;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(6,182,212,0.3);
    }
    
    button.secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(6,182,212,0.3);
    }
    
    button.secondary:hover {
      background: rgba(6,182,212,0.1);
    }
    
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .col {
      flex: 1;
    }
    
    .muted {
      color: var(--muted);
    }
    
    .posts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
    }
    
    .post-card {
      border-radius: 12px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      position: relative;
      transition: all 0.3s;
    }
    
    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .post-image {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.3s;
      aspect-ratio: 1/1;
      object-fit: cover;
    }
    
    .post-image:hover {
      transform: scale(1.02);
    }
    
    .profile-avatar {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: linear-gradient(180deg, #0a2230, #05202a);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-weight: 700;
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    .hidden {
      display: none !important;
    }
    
    .toast {
      position: fixed;
      left: 16px;
      bottom: 120px;
      background: var(--success);
      color: #001219;
      padding: 12px 16px;
      border-radius: 8px;
      z-index: 3000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s, slideOut 0.3s 1.9s;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }
    
    .toast.error {
      background: var(--error);
    }
    
    .toast.warning {
      background: var(--warning);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .stats {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }
    
    .stat {
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
    }
    
    .stat-value {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--accent);
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    @media (max-width: 1100px) {
      .side-ad {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding-bottom: 70px;
      }
      
      #bottomAd {
        padding: 6px 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <div class="logo">سوشيال نايت</div>
        <div class="small">شبكة مشاركة الصور — نسختك التجريبية</div>
      </div>
    </div>
    <div class="row" id="nav-right">
      <div id="nav-guest" class="row">
        <button onclick="showScreen('register')">تسجيل</button>
        <button class="secondary" onclick="showScreen('login')">دخول</button>
      </div>
      <div id="nav-user" class="row hidden">
        <span id="nav-username" class="muted"></span>
        <button class="secondary" onclick="goToProfile()">ملفي</button>
        <button class="secondary" onclick="logout()">خروج</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="screen-home" class="screen">
      <div class="card row">
        <div class="col">
          <h2>التغذية</h2>
          <div class="small">منشورات المستخدمين. عند الضغط على الصورة سيظهر معاينتها مع إعلان غير مزعج.</div>
        </div>
        <div>
          <button id="btn-new-post" onclick="showScreen('newpost')">+ نشر جديد</button>
        </div>
      </div>

      <!-- إعلان في التغذية -->
      <div class="feed-ad hidden" id="feed-ad-1">
        <div class="feed-ad-label">إعلان</div>
        <div id="feed-ad-container-1" class="ad-unit"></div>
      </div>

      <div id="feed" class="posts-grid">
        <div class="card" style="text-align: center; padding: 40px;">
          <div class="loading"></div>
          <p class="muted">جاري تحميل المنشورات...</p>
        </div>
      </div>
    </div>

    <div id="screen-register" class="screen hidden">
      <div class="card">
        <h3>إنشاء حساب</h3>
        <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">
          <input id="reg-display" placeholder="الاسم الظاهر" />
          <input id="reg-username" placeholder="اسم المستخدم (مميز)" />
          <input id="reg-email" placeholder="البريد الإلكتروني" type="email" />
          <input id="reg-password" placeholder="كلمة المرور" type="password" />
          <div style="display:flex;gap:8px">
            <button onclick="register()">سجل الآن</button>
            <button class="secondary" onclick="showScreen('home')">عودة</button>
          </div>
          <div class="small">سيتم التحقق من البريد وكلمة المرور. لا تُخزن كلمات المرور على الخادم بصيغة النص العادي.</div>
        </div>
      </div>
    </div>

    <div id="screen-login" class="screen hidden">
      <div class="card">
        <h3>تسجيل الدخول</h3>
        <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">
          <input id="login-email" placeholder="البريد الإلكتروني" type="email" />
          <input id="login-password" placeholder="كلمة المرور" type="password" />
          <div style="display:flex;gap:8px">
            <button onclick="login()">دخول</button>
            <button class="secondary" onclick="showScreen('home')">عودة</button>
          </div>
        </div>
      </div>
    </div>

    <div id="screen-newpost" class="screen hidden">
      <div class="card">
        <h3>نشر جديد</h3>
        <textarea id="post-text" rows="3" placeholder="نص المنشور (اختياري)"></textarea>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input type="file" id="post-image" accept="image/*" />
          <div class="small">سيتم فحص الصور تلقائياً وحجب الصور غير الملائمة.</div>
        </div>
        <div style="margin-top:16px;display:flex;gap:8px">
          <button onclick="createPost()">نشر</button>
          <button class="secondary" onclick="showScreen('home')">إلغاء</button>
        </div>
      </div>
    </div>

    <div id="screen-profile" class="screen hidden">
      <div class="card">
        <div class="row" style="align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div id="profile-avatar" class="profile-avatar">ص</div>
            <div>
              <div id="profile-name" style="font-weight:800"></div>
              <div id="profile-username" class="small muted"></div>
            </div>
          </div>
          <div style="margin-left:auto">
            <button id="follow-btn" class="follow-btn hidden" onclick="toggleFollow()">متابعة</button>
          </div>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="posts-count">0</div>
            <div class="stat-label">منشورات</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="followers-count">0</div>
            <div class="stat-label">متابِعون</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="earnings-count">0</div>
            <div class="stat-label">أرباح</div>
          </div>
        </div>
        <hr style="margin:16px 0;border-color:rgba(255,255,255,0.03)">
        <div><h4>منشورات المستخدم</h4></div>
        <div id="profile-posts" class="posts-grid" style="margin-top:12px">
          <div class="card" style="text-align: center; padding: 40px;">
            <div class="loading"></div>
            <p class="muted">جاري تحميل المنشورات...</p>
          </div>
        </div>
      </div>
    </div>

    <div id="screen-post" class="screen hidden">
      <div class="card" id="post-view"></div>
    </div>

  </div>

  <!-- إعلان جانبي -->
  <div class="side-ad hidden" id="sideAd">
    <button class="side-ad-close" onclick="closeSideAd()">×</button>
    <div class="small" style="margin-bottom: 8px;">إعلان</div>
    <div id="side-ad-container" class="ad-unit"></div>
  </div>

  <!-- إعلان ثابت في الأسفل -->
  <div id="bottomAd" class="hidden">
    <button class="ad-close-btn" onclick="closeBottomAd()">×</button>
    <div id="bottom-ad-container" class="ad-unit"></div>
  </div>

  <!-- مودال الصور -->
  <div id="image-modal" class="modal hidden">
    <!-- محتوى المودال الأصلي -->
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase SDKs المحدثة -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- TensorFlow و NSFWJS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nsfwjs@2.4.2/dist/nsfwjs.min.js"></script>

  <script>
    /**************************************************************************
      Firebase config - الإعدادات الجديدة لمشروعك
    ***************************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCwWu4uYybA2Vj_Zk2UF95MhLd0CB_z7z4",
      authDomain: "social-night-f37bf.firebaseapp.com",
      projectId: "social-night-f37bf",
      storageBucket: "social-night-f37bf.firebasestorage.app",
      messagingSenderId: "505583934849",
      appId: "1:505583934849:web:62d594e8ba03238ad11c80",
      measurementId: "G-D4J4GBRRNG"
    };

    // تهيئة Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // إعدادات التطبيق
    const App = {
      nsfwModel: null,
      currentUser: null,
      userData: {},
      posts: [],
      currentProfile: null,
      adSettings: {
        bottomAdEnabled: true,
        sideAdEnabled: true,
        feedAdsEnabled: true,
        adRefreshInterval: 30000
      }
    };

    // نظام الإعلانات
    const AdManager = {
      init() {
        this.loadAds();
        this.setupAdRefresh();
        this.setupAdEventListeners();
      },
      
      loadAds() {
        // تحميل الإعلان الثابت في الأسفل
        if (App.adSettings.bottomAdEnabled) {
          this.loadBottomAd();
          document.getElementById('bottomAd').classList.remove('hidden');
        }
        
        // تحميل الإعلان الجانبي بعد تأخير
        if (App.adSettings.sideAdEnabled) {
          setTimeout(() => {
            this.loadSideAd();
            document.getElementById('sideAd').classList.remove('hidden');
          }, 5000);
        }
        
        // تحميل إعلانات التغذية
        if (App.adSettings.feedAdsEnabled) {
          setTimeout(() => {
            this.loadFeedAd();
            document.getElementById('feed-ad-1').classList.remove('hidden');
          }, 3000);
        }
      },
      
      loadBottomAd() {
        const container = document.getElementById('bottom-ad-container');
        if (!container) return;
        
        const iframe = document.createElement('iframe');
        iframe.style.width = '320px';
        iframe.style.height = '50px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.sandbox = 'allow-scripts allow-popups allow-forms allow-same-origin';
        
        const adHTML = `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="referrer" content="no-referrer">
              <style>body{margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;}</style>
              <script type="text/javascript">
                atOptions = {
                  'key' : '2d5deaded3e62ebc9943db8d8b49f74e',
                  'format' : 'iframe',
                  'height' : 50,
                  'width' : 320,
                  'params' : {}
                };
              <\/script>
              <script type="text/javascript" src="//www.highperformanceformat.com/2d5deaded3e62ebc9943db8d8b49f74e/invoke.js"><\/script>
            </head>
            <body>
              <div id="ad-container"></div>
              <script>
                document.write('<scr' + 'ipt type="text/javascript" src="//www.highperformanceformat.com/2d5deaded3e62ebc9943db8d8b49f74e/invoke.js"><\/scr' + 'ipt>');
              <\/script>
            </body>
          </html>
        `;
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.srcdoc = adHTML;
      },
      
      loadSideAd() {
        const container = document.getElementById('side-ad-container');
        if (!container) return;
        
        const iframe = document.createElement('iframe');
        iframe.style.width = '160px';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.sandbox = 'allow-scripts allow-popups allow-forms allow-same-origin';
        
        const adHTML = `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="referrer" content="no-referrer">
              <style>body{margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;height:100%;}</style>
            </head>
            <body>
              <script type='text/javascript' src='//pl27783662.effectivegatecpm.com/8d/f4/a9/8df4a9bd2d8c6909d8f0cfc70ea9ec02.js'><\/script>
            </body>
          </html>
        `;
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.srcdoc = adHTML;
      },
      
      loadFeedAd() {
        const container = document.getElementById('feed-ad-container-1');
        if (!container) return;
        
        const iframe = document.createElement('iframe');
        iframe.style.width = '300px';
        iframe.style.height = '250px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.sandbox = 'allow-scripts allow-popups allow-forms allow-same-origin';
        
        const adHTML = `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="referrer" content="no-referrer">
              <style>body{margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;height:100%;}</style>
              <script type="text/javascript">
                atOptions = {
                  'key' : '3fa8b00fc8159153c0596ee9ffb026ea',
                  'format' : 'iframe',
                  'height' : 250,
                  'width' : 300,
                  'params' : {}
                };
              <\/script>
            </head>
            <body>
              <div id="ad-container"></div>
              <script>
                document.write('<scr' + 'ipt type="text/javascript" src="//www.highperformanceformat.com/3fa8b00fc8159153c0596ee9ffb026ea/invoke.js"><\/scr' + 'ipt>');
              <\/script>
            </body>
          </html>
        `;
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.srcdoc = adHTML;
      },
      
      setupAdRefresh() {
        setInterval(() => {
          this.refreshAds();
        }, App.adSettings.adRefreshInterval);
      },
      
      refreshAds() {
        if (App.adSettings.bottomAdEnabled) {
          this.loadBottomAd();
        }
        
        if (App.adSettings.feedAdsEnabled) {
          this.loadFeedAd();
        }
      },
      
      setupAdEventListeners() {
        document.addEventListener('click', (e) => {
          if (e.target.closest('.ad-unit, .side-ad, #bottomAd')) {
            this.recordAdInteraction('click');
          }
        });
      },
      
      recordAdInteraction(type) {
        if (!App.currentUser) return;
        
        try {
          db.collection('adInteractions').add({
            userId: App.currentUser.uid,
            type: type,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            adPosition: type === 'click' ? 'bottom' : 'view'
          });
        } catch (error) {
          console.error('Error recording ad interaction:', error);
        }
      }
    };

    // وظائف إدارة الإعلانات
    function closeBottomAd() {
      document.getElementById('bottomAd').classList.add('hidden');
      localStorage.setItem('bottomAdClosed', 'true');
    }
    
    function closeSideAd() {
      document.getElementById('sideAd').classList.add('hidden');
      localStorage.setItem('sideAdClosed', 'true');
    }

    // وظائف المساعدة
    function showScreen(id) { 
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
      document.getElementById('screen-' + id).classList.remove('hidden'); 
      window.scrollTo(0, 0); 
    }

    function toast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type}`;
      t.classList.remove('hidden');
      
      setTimeout(() => {
        t.classList.add('hidden');
      }, 2200);
    }

    // وظائف المصادقة والإدارة - تم إصلاحها
    async function register() {
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const username = document.getElementById('reg-username').value.trim();
      const display = document.getElementById('reg-display').value.trim();
      
      if (!email || !password || !username) {
        toast('اكمل الحقول المطلوبة', 'warning');
        return;
      }
      
      try {
        // التحقق من اسم المستخدم
        const uSnap = await db.collection('usernames').doc(username).get();
        if (uSnap.exists) {
          toast('اسم المستخدم مأخوذ', 'error');
          return;
        }
        
        // إنشاء المستخدم في Authentication
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        const uid = cred.user.uid;
        
        // حفظ بيانات المستخدم في Firestore
        await db.collection('users').doc(uid).set({
          username: username,
          displayName: display || username,
          email: email,
          created: firebase.firestore.FieldValue.serverTimestamp(),
          followersCount: 0,
          earnings: 0,
          postsCount: 0
        });
        
        // حفظ اسم المستخدم للتحقق من التكرار
        await db.collection('usernames').doc(username).set({ 
          uid: uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        toast('تم إنشاء الحساب بنجاح! يمكنك تسجيل الدخول الآن');
        showScreen('login');
        
      } catch (error) {
        console.error('Registration error:', error);
        let errorMessage = 'فشل التسجيل: ';
        
        switch(error.code) {
          case 'auth/email-already-in-use':
            errorMessage += 'البريد الإلكتروني مستخدم بالفعل';
            break;
          case 'auth/invalid-email':
            errorMessage += 'البريد الإلكتروني غير صحيح';
            break;
          case 'auth/weak-password':
            errorMessage += 'كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل';
            break;
          default:
            errorMessage += error.message || 'حدث خطأ غير متوقع';
        }
        
        toast(errorMessage, 'error');
      }
    }

    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      
      if (!email || !password) {
        toast('ادخل البريد وكلمة المرور', 'warning');
        return;
      }
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        toast('تم تسجيل الدخول بنجاح');
      } catch (error) {
        console.error('Login error:', error);
        let errorMessage = 'فشل الدخول: ';
        
        switch(error.code) {
          case 'auth/user-not-found':
            errorMessage += 'المستخدم غير موجود';
            break;
          case 'auth/wrong-password':
            errorMessage += 'كلمة المرور غير صحيحة';
            break;
          case 'auth/invalid-email':
            errorMessage += 'البريد الإلكتروني غير صحيح';
            break;
          default:
            errorMessage += error.message || 'حدث خطأ غير متوقع';
        }
        
        toast(errorMessage, 'error');
      }
    }

    function logout() {
      auth.signOut();
      toast('تم تسجيل الخروج');
    }

    // إدارة حالة المستخدم
    auth.onAuthStateChanged(async user => {
      const navUser = document.getElementById('nav-user');
      const navGuest = document.getElementById('nav-guest');
      
      if (user) {
        App.currentUser = user;
        navGuest.classList.add('hidden');
        navUser.classList.remove('hidden');
        
        try {
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) {
            App.userData = doc.data();
            document.getElementById('nav-username').textContent = App.userData.displayName || App.userData.username || user.email;
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
        }
        
        renderFeed();
      } else {
        App.currentUser = null;
        App.userData = {};
        navUser.classList.add('hidden');
        navGuest.classList.remove('hidden');
        document.getElementById('nav-username').textContent = '';
        renderFeed();
      }
    });

    // وظائف المنشورات
    async function createPost() {
      const text = document.getElementById('post-text').value.trim();
      const fileInput = document.getElementById('post-image');
      
      if (!App.currentUser) {
        toast('سجّل دخول أولاً', 'warning');
        return;
      }
      
      if (fileInput.files.length === 0 && !text) {
        toast('أضف نصاً أو صورة', 'warning');
        return;
      }
      
      let imageUrl = null;
      
      // معالجة الصورة إذا تم تحميلها
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        
        // فحص الصورة باستخدام NSFW إذا كان النموذج متاحاً
        if (App.nsfwModel) {
          try {
            const img = await fileToImage(file);
            const predictions = await App.nsfwModel.classify(img);
            const risky = predictions.find(p => ['Porn', 'Hentai', 'Sexy'].includes(p.className));
            
            if (risky && risky.probability > 0.70) {
              toast('تم حجب الصورة لوجود محتوى غير ملائم', 'error');
              return;
            }
          } catch (error) {
            console.error('NSFW check error:', error);
          }
        }
        
        // رفع الصورة إلى التخزين
        try {
          const path = `posts/${App.currentUser.uid}/${Date.now()}_${file.name}`;
          const ref = storage.ref().child(path);
          await ref.put(file);
          imageUrl = await ref.getDownloadURL();
        } catch (error) {
          console.error('Image upload error:', error);
          toast('فشل تحميل الصورة', 'error');
          return;
        }
      }
      
      // حفظ المنشور في قاعدة البيانات
      try {
        await db.collection('posts').add({
          uid: App.currentUser.uid,
          username: App.userData.username,
          displayName: App.userData.displayName,
          text,
          imageUrl,
          created: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          commentsCount: 0
        });
        
        // تحديث عدد منشورات المستخدم
        await db.collection('users').doc(App.currentUser.uid).update({
          postsCount: firebase.firestore.FieldValue.increment(1)
        });
        
        toast('تم النشر بنجاح');
        document.getElementById('post-text').value = '';
        document.getElementById('post-image').value = '';
        showScreen('home');
        renderFeed();
      } catch (error) {
        console.error('Post creation error:', error);
        toast('فشل نشر المنشور', 'error');
      }
    }

    function fileToImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(file);
      });
    }

    // عرض التغذية
    async function renderFeed() {
      const feed = document.getElementById('feed');
      feed.innerHTML = '<div class="card" style="text-align: center; padding: 40px;"><div class="loading"></div><p class="muted">جاري تحميل المنشورات...</p></div>';
      
      try {
        const snapshot = await db.collection('posts').orderBy('created', 'desc').limit(50).get();
        
        if (snapshot.empty) {
          feed.innerHTML = '<div class="card">لا توجد منشورات بعد. كن أول من ينشر!</div>';
          return;
        }
        
        App.posts = [];
        feed.innerHTML = '';
        
        snapshot.forEach(doc => {
          const post = { id: doc.id, ...doc.data() };
          App.posts.push(post);
          const el = buildPostCard(post);
          feed.appendChild(el);
        });
      } catch (error) {
        console.error('Error loading feed:', error);
        feed.innerHTML = '<div class="card">حدث خطأ في تحميل المنشورات</div>';
      }
    }

    function buildPostCard(post) {
      const div = document.createElement('div');
      div.className = 'post-card card';
      div.dataset.postId = post.id;
      
      // رأس المنشور
      const header = document.createElement('div');
      header.className = 'row';
      
      const avatar = document.createElement('div');
      avatar.className = 'profile-avatar';
      avatar.textContent = (post.displayName || post.username || 'م').charAt(0);
      
      const meta = document.createElement('div');
      meta.className = 'col';
      
      const name = document.createElement('div');
      name.textContent = post.displayName || post.username || 'مستخدم';
      name.style.fontWeight = '700';
      
      const time = document.createElement('div');
      time.className = 'small muted';
      time.textContent = post.created ? 
        new Date(post.created.seconds * 1000).toLocaleString('ar-EG') : 
        'الآن';
      
      meta.appendChild(name);
      meta.appendChild(time);
      header.appendChild(avatar);
      header.appendChild(meta);
      div.appendChild(header);
      
      // محتوى المنشور
      const content = document.createElement('div');
      if (post.text) {
        const textDiv = document.createElement('div');
        textDiv.style.marginTop = '8px';
        textDiv.innerHTML = escapeHTML(post.text);
        content.appendChild(textDiv);
      }
      
      if (post.imageUrl) {
        const img = document.createElement('img');
        img.src = post.imageUrl;
        img.className = 'post-image';
        img.alt = 'صورة المنشور';
        img.onclick = () => openImageModal(post);
        content.appendChild(img);
      }
      
      div.appendChild(content);
      
      // إجراءات المنشور
      const actions = document.createElement('div');
      actions.className = 'actions';
      
      const likeBtn = document.createElement('button');
      likeBtn.className = 'like-btn';
      likeBtn.innerHTML = `
        <span class="heart" data-id="${post.id}">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 20s-7-4.35-9.5-7.1C-1.33 8.58 3 4 7.5 6.5 10 8 12 10 12 10s2-2 4.5-3.5C21 4 24.33 8.58 21.5 12.9 19 15.65 12 20 12 20z" fill="#ff647c"/>
          </svg>
        </span>
      `;
      likeBtn.onclick = () => handleLike(post.id, likeBtn);
      
      const likeCount = document.createElement('div');
      likeCount.className = 'small muted';
      likeCount.textContent = post.likes || 0;
      likeCount.id = `likes-${post.id}`;
      
      const commentBtn = document.createElement('button');
      commentBtn.className = 'comment-btn secondary';
      commentBtn.textContent = 'تعليق';
      commentBtn.onclick = () => openComments(post.id);
      
      actions.appendChild(likeBtn);
      actions.appendChild(likeCount);
      actions.appendChild(commentBtn);
      div.appendChild(actions);
      
      return div;
    }

    async function handleLike(postId, btn) {
      if (!App.currentUser) {
        toast('سجل دخول أولاً للإعجاب', 'warning');
        return;
      }
      
      const heart = btn.querySelector('.heart');
      heart.classList.add('animate');
      
      setTimeout(() => {
        heart.classList.remove('animate');
      }, 350);
      
      try {
        const ref = db.collection('posts').doc(postId);
        await db.runTransaction(async transaction => {
          const doc = await transaction.get(ref);
          if (!doc.exists) return;
          
          const currentLikes = doc.data().likes || 0;
          transaction.update(ref, { likes: currentLikes + 1 });
        });
        
        // تحديث العدد المعروض
        const likeCount = document.getElementById(`likes-${postId}`);
        if (likeCount) {
          const current = parseInt(likeCount.textContent) || 0;
          likeCount.textContent = current + 1;
        }
      } catch (error) {
        console.error('Like error:', error);
      }
    }

    async function openComments(postId) {
      const box = document.getElementById('comments_' + postId);
      if (!box) return;
      
      box.classList.toggle('hidden');
      
      if (!box.classList.contains('hidden')) {
        await loadComments(postId);
      }
    }

    async function loadComments(postId) {
      const list = document.querySelector('#comments_' + postId + ' .comments-list');
      if (!list) return;
      
      list.innerHTML = '<div class="small muted" style="text-align:center">جاري تحميل التعليقات...</div>';
      
      try {
        const snap = await db.collection('posts').doc(postId).collection('comments').orderBy('created', 'asc').get();
        
        if (snap.empty) {
          list.innerHTML = '<div class="small muted" style="text-align:center">لا توجد تعليقات بعد</div>';
          return;
        }
        
        list.innerHTML = '';
        snap.forEach(doc => {
          const comment = doc.data();
          const el = document.createElement('div');
          el.className = 'comment-item';
          el.textContent = (comment.displayName || comment.username || 'مستخدم') + ': ' + comment.text;
          list.appendChild(el);
        });
      } catch (error) {
        console.error('Error loading comments:', error);
        list.innerHTML = '<div class="small muted" style="text-align:center">خطأ في تحميل التعليقات</div>';
      }
    }

    async function postComment(postId, input) {
      if (!App.currentUser) {
        toast('سجل دخول أولاً', 'warning');
        return;
      }
      
      const text = input.value.trim();
      if (!text) return;
      
      try {
        await db.collection('posts').doc(postId).collection('comments').add({
          uid: App.currentUser.uid,
          username: App.userData.username,
          displayName: App.userData.displayName,
          text,
          created: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // تحديث عدد التعليقات
        const ref = db.collection('posts').doc(postId);
        await ref.update({
          commentsCount: firebase.firestore.FieldValue.increment(1)
        });
        
        input.value = '';
        loadComments(postId);
        toast('تم إضافة التعليق');
      } catch (error) {
        console.error('Comment error:', error);
        toast('فشل إضافة التعليق', 'error');
      }
    }

    // Modal للصور
    function openImageModal(post) {
      document.getElementById('modal-img').src = post.imageUrl || '';
      document.getElementById('modal-post-meta').textContent = 
        (post.text ? post.text.substring(0, 100) + (post.text.length > 100 ? '...' : '') : '') + 
        ' — من: ' + (post.displayName || post.username || 'مستخدم');
      
      document.getElementById('image-modal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('image-modal').classList.add('hidden');
      document.getElementById('modal-img').src = '';
    }

    // الملف الشخصي والمتابعة
    async function goToProfile(username) {
      if (!username) {
        if (!App.currentUser) {
          toast('سجل دخول أولاً', 'warning');
          return;
        }
        username = App.userData.username;
      }
      
      window.location.hash = 'profile=' + username;
      renderRoute();
    }

    async function renderProfile(username) {
      showScreen('profile');
      App.currentProfile = username;
      
      try {
        const uSnap = await db.collection('usernames').doc(username).get();
        if (!uSnap.exists) {
          toast('المستخدم غير موجود', 'error');
          showScreen('home');
          return;
        }
        
        const uid = uSnap.data().uid;
        const doc = await db.collection('users').doc(uid).get();
        
        if (!doc.exists) {
          toast('المستخدم غير موجود', 'error');
          showScreen('home');
          return;
        }
        
        const data = doc.data();
        document.getElementById('profile-name').textContent = data.displayName || username;
        document.getElementById('profile-username').textContent = '@' + username;
        
        // تحديث الإحصائيات
        document.getElementById('posts-count').textContent = data.postsCount || 0;
        document.getElementById('followers-count').textContent = data.followersCount || 0;
        document.getElementById('earnings-count').textContent = (data.earnings || 0).toFixed(2);
        
        // زر المتابعة
        const followBtn = document.getElementById('follow-btn');
        followBtn.dataset.target = uid;
        
        if (App.currentUser && App.currentUser.uid !== uid) {
          followBtn.classList.remove('hidden');
          const fDoc = await db.collection('follows').doc(`${App.currentUser.uid}_${uid}`).get();
          followBtn.textContent = fDoc.exists ? 'متابع' : 'متابعة';
        } else {
          followBtn.classList.add('hidden');
        }
        
        // تحميل منشورات المستخدم
        const grid = document.getElementById('profile-posts');
        grid.innerHTML = '<div class="card" style="text-align: center; padding: 40px;"><div class="loading"></div><p class="muted">جاري تحميل المنشورات...</p></div>';
        
        const snap = await db.collection('posts').where('uid', '==', uid).orderBy('created', 'desc').get();
        
        if (snap.empty) {
          grid.innerHTML = '<div class="card">لا توجد منشورات بعد</div>';
        } else {
          grid.innerHTML = '';
          snap.forEach(doc => {
            const post = { id: doc.id, ...doc.data() };
            grid.appendChild(buildPostCard(post));
          });
        }
      } catch (error) {
        console.error('Profile loading error:', error);
        toast('خطأ في تحميل الملف الشخصي', 'error');
      }
    }

    function escapeHTML(s) {
      if (!s) return '';
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // Router للتطبيق
    function parseHash() {
      const hash = location.hash.slice(1);
      if (!hash) return { type: 'home' };
      
      if (hash.startsWith('profile=')) {
        return { type: 'profile', id: hash.split('=')[1] };
      }
      
      return { type: 'home' };
    }

    window.addEventListener('hashchange', renderRoute);
    
    function renderRoute() {
      const route = parseHash();
      
      if (route.type === 'home') {
        showScreen('home');
        renderFeed();
      } else if (route.type === 'profile') {
        renderProfile(route.id);
      }
    }

    // تحميل نموذج NSFW
    async function loadNSFWModel() {
      try {
        App.nsfwModel = await nsfwjs.load();
        console.log('NSFW model loaded successfully');
      } catch (error) {
        console.warn('NSFW model failed to load:', error);
      }
    }

    // تهيئة التطبيق
    async function init() {
      await loadNSFWModel();
      AdManager.init();
      renderRoute();
      
      // التحقق من تفضيلات الإعلانات السابقة
      if (localStorage.getItem('bottomAdClosed') === 'true') {
        document.getElementById('bottomAd').classList.add('hidden');
      }
      
      if (localStorage.getItem('sideAdClosed') === 'true') {
        document.getElementById('sideAd').classList.add('hidden');
      }
    }

    // جعل الدوال متاحة globally
    window.showScreen = showScreen;
    window.toast = toast;
    window.register = register;
    window.login = login;
    window.logout = logout;
    window.createPost = createPost;
    window.closeBottomAd = closeBottomAd;
    window.closeSideAd = closeSideAd;
    window.goToProfile = goToProfile;
    window.openImageModal = openImageModal;
    window.closeModal = closeModal;
    window.openComments = openComments;
    window.postComment = postComment;
    window.handleLike = handleLike;

    // بدء التطبيق
    init();
  </script>
</body>
</html>
