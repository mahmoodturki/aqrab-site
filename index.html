<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MarketVista - Ù…Ù†ØµØ© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<style>
  * {
    box-sizing: border-box;
  }
  body {
    margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1f4068, #2980b9);
    color: #fff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: rgba(0,0,0,0.3);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  header h1 {
    font-weight: 800;
    user-select: none;
  }
  nav ul {
    list-style: none;
    display: flex;
    gap: 1.25rem;
  }
  nav a {
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    user-select: none;
  }
  nav a:hover, nav a:focus {
    color: #f39c12;
    outline: none;
  }
  #visitorCount {
    background: #f39c12;
    padding: 0.3rem 0.7rem;
    border-radius: 20px;
    font-weight: bold;
    user-select: none;
  }
  #userArea {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  #userArea img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #f39c12;
    user-select: none;
  }
  button {
    background: #f39c12;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    color: #222;
    transition: background 0.3s;
    user-select: none;
  }
  button:hover, button:focus {
    background: #d48806;
    outline: none;
  }
  main {
    flex: 1;
    padding: 1rem 1.5rem;
    max-width: 1000px;
    margin: 0 auto 3rem;
  }
  section {
    margin-bottom: 2rem;
  }
  #productsGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 1.5rem;
  }
  .product-card {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    user-select: none;
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
  }
  .product-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 0.8rem;
    pointer-events:none;
  }
  .product-info h3 {
    margin: 0 0 0.3rem;
    font-weight: 700;
    font-size: 1.2rem;
  }
  .product-info p {
    flex-grow: 1;
    font-size: 0.9rem;
    opacity: 0.85;
    margin-bottom: 0.6rem;
  }
  .product-info .price {
    font-weight: 700;
    color: #f39c12;
    margin-bottom: 0.6rem;
  }
  .actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .actions button {
    flex: 1 1 calc(33% - 0.5rem);
    font-size: 0.9rem;
    border-radius: 8px;
    background: rgba(243, 156, 18, 0.85);
    color: #222;
  }
  .actions button.active {
    background: #d48806;
    color: #fff;
  }
  .actions button:hover, .actions button:focus {
    background: #d48806;
    outline: none;
    color: #fff;
  }
  .comments-list {
    margin-top: 0.6rem;
    max-height: 100px;
    overflow-y: auto;
    font-size: 0.85rem;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 0.5rem;
  }
  .comments-list p {
    margin: 0 0 0.3rem;
  }
  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.7);
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 1rem;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: linear-gradient(135deg,#1f4068,#2980b9);
    padding: 1.5rem;
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    color: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  .modal-content h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-weight: 800;
    user-select: none;
  }
  .modal-content label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 700;
  }
  .modal-content input[type="text"],
  .modal-content input[type="number"],
  .modal-content textarea,
  .modal-content input[type="file"] {
    width: 100%;
    padding: 0.4rem;
    border-radius: 6px;
    border: none;
    margin-bottom: 1rem;
    font-size: 1rem;
  }
  .modal-content textarea {
    resize: vertical;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }
  .modal-actions button {
    flex: none;
  }
  /* Ads */
  .ad-banner {
    width: 100%;
    height: 60px;
    background: #222;
    color: #f39c12;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 1rem 0;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1.1rem;
    user-select: none;
  }
  .ad-inline {
    background: #222;
    color: #f39c12;
    padding: 0.5rem;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1rem;
    text-align: center;
    margin-bottom: 1rem;
    user-select: none;
  }
  /* Responsive */
  @media (max-width: 480px) {
    header {
      flex-wrap: wrap;
      gap: 0.8rem;
    }
    nav ul {
      flex-wrap: wrap;
      justify-content: center;
    }
    .actions button {
      flex: 1 1 100%;
    }
  }
</style>
</head>
<body>
<header>
  <h1>MarketVista</h1>
  <nav aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <ul>
      <li><a href="#" id="navHome" tabindex="0">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li><a href="#" id="navProducts" tabindex="0">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a></li>
    </ul>
  </nav>
  <div id="visitorCount" aria-label="Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±">0</div>
  <div id="userArea" aria-live="polite" aria-atomic="true">
    <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>
</header>

<main>
  <section id="homeSection" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <div class="ad-banner">Ø¥Ø¹Ù„Ø§Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© - Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…Ø²Ø¹Ø¬</div>
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ MarketVista</h2>
    <p>Ù…Ù†ØµØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ ÙˆØªØ³ÙˆÙŠÙ‚ Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
  </section>

  <section id="productsSection" aria-label="Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" style="display:none;">
    <div class="ad-inline">Ø¥Ø¹Ù„Ø§Ù† Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div id="productsGrid" aria-live="polite" aria-relevant="additions"></div>
  </section>
</main>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…ÙˆØ¯Ø§Ù„ -->
<div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle" tabindex="-1">
  <div class="modal-content">
    <h2 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <form id="loginForm">
      <label for="usernameInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input type="text" id="usernameInput" required autocomplete="username" />
      <label for="userAvatar">ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</label>
      <input type="file" id="userAvatar" accept="image/*" aria-describedby="avatarDesc"/>
      <img id="avatarPreview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„" style="width:80px;height:80px;border-radius:50%;display:none;margin-bottom:1rem;object-fit:cover;border:2px solid #f39c12;" />
      <div class="modal-actions">
        <button type="button" id="cancelLoginBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </form>
  </div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù…ÙˆØ¯Ø§Ù„ -->
<div id="addProductModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addProductTitle" tabindex="-1">
  <div class="modal-content">
    <h2 id="addProductTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="addProductForm">
      <label for="productNameInput">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
      <input type="text" id="productNameInput" required />
      <label for="productDescInput">Ø§Ù„ÙˆØµÙ</label>
      <textarea id="productDescInput" rows="3" required></textarea>
      <label for="productPriceInput">Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)</label>
      <input type="number" id="productPriceInput" min="0" step="0.01" required />
      <label for="productImageInput">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
      <input type="file" id="productImageInput" accept="image/*" required />
      <img id="productImagePreview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" style="width:100%;max-height:200px;object-fit:cover;border-radius:10px;display:none;margin-bottom:1rem;" />
      <div class="modal-actions">
        <button type="button" id="cancelAddProductBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  // Ø¹Ù†Ø§ØµØ± DOM
  const visitorCountEl = document.getElementById('visitorCount');
  const userAreaEl = document.getElementById('userArea');
  const loginBtn = document.getElementById('loginBtn');
  const navHome = document.getElementById('navHome');
  const navProducts = document.getElementById('navProducts');
  const homeSection = document.getElementById('homeSection');
  const productsSection = document.getElementById('productsSection');
  const productsGrid = document.getElementById('productsGrid');

  const loginModal = document.getElementById('loginModal');
  const loginForm = document.getElementById('loginForm');
  const usernameInput = document.getElementById('usernameInput');
  const userAvatarInput = document.getElementById('userAvatar');
  const avatarPreview = document.getElementById('avatarPreview');
  const cancelLoginBtn = document.getElementById('cancelLoginBtn');

  const addProductModal = document.getElementById('addProductModal');
  const addProductForm = document.getElementById('addProductForm');
  const productNameInput = document.getElementById('productNameInput');
  const productDescInput = document.getElementById('productDescInput');
  const productPriceInput = document.getElementById('productPriceInput');
  const productImageInput = document.getElementById('productImageInput');
  const productImagePreview = document.getElementById('productImagePreview');
  const cancelAddProductBtn = document.getElementById('cancelAddProductBtn');

  let currentUser = null;
  let products = [];

  // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±
  function incrementVisitorCount() {
    let count = localStorage.getItem('visitorCount') || 0;
    count = parseInt(count) + 1;
    localStorage.setItem('visitorCount', count);
    visitorCountEl.textContent = count;
  }
  function loadVisitorCount() {
    let count = localStorage.getItem('visitorCount') || 0;
    visitorCountEl.textContent = count;
  }

  // Ø­ÙØ¸ / ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  function saveCurrentUser() {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  }
  function loadCurrentUser() {
    const stored = localStorage.getItem('currentUser');
    if(stored) {
      currentUser = JSON.parse(stored);
      updateUserArea();
    }
  }

  // Ø­ÙØ¸ / ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  function saveProducts() {
    localStorage.setItem('products', JSON.stringify(products));
  }
  function loadProducts() {
    const stored = localStorage.getItem('products');
    if(stored) {
      products = JSON.parse(stored);
    } else {
      products = [];
    }
  }

  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬)
  function updateUserArea() {
    userAreaEl.innerHTML = '';
    if(currentUser){
      const img = document.createElement('img');
      img.src = currentUser.avatar || 'https://via.placeholder.com/40?text=User';
      img.alt = `ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ${currentUser.username}`;
      const span = document.createElement('span');
      span.textContent = currentUser.username;
      span.style.userSelect = 'text';
      const logoutBtn = document.createElement('button');
      logoutBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
      logoutBtn.addEventListener('click', () => {
        currentUser = null;
        saveCurrentUser();
        updateUserArea();
      });
      const addProdBtn = document.createElement('button');
      addProdBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬';
      addProdBtn.addEventListener('click', () => {
        openModal(addProductModal);
      });
      userAreaEl.appendChild(img);
      userAreaEl.appendChild(span);
      userAreaEl.appendChild(addProdBtn);
      userAreaEl.appendChild(logoutBtn);
    } else {
      const btn = document.createElement('button');
      btn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      btn.addEventListener('click', () => openModal(loginModal));
      userAreaEl.appendChild(btn);
    }
  }

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„
  function openModal(modal) {
    modal.classList.add('active');
    // focus first input or button inside modal
    const focusable = modal.querySelector('input, button, textarea');
    if(focusable) focusable.focus();
  }
  function closeModal(modal) {
    modal.classList.remove('active');
  }

  // Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  userAvatarInput.addEventListener('change', () => {
    const file = userAvatarInput.files[0];
    if(file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => {
        avatarPreview.src = e.target.result;
        avatarPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      avatarPreview.style.display = 'none';
    }
  });

  // Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
  productImageInput.addEventListener('change', () => {
    const file = productImageInput.files[0];
    if(file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => {
        productImagePreview.src = e.target.result;
        productImagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      productImagePreview.style.display = 'none';
    }
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = usernameInput.value.trim();
    if(!username) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      return;
    }
    let avatar = 'https://via.placeholder.com/40?text=User';
    if(userAvatarInput.files[0]) {
      const file = userAvatarInput.files[0];
      const reader = new FileReader();
      reader.onload = e => {
        avatar = e.target.result;
        finishLogin(username, avatar);
      };
      reader.readAsDataURL(file);
    } else {
      finishLogin(username, avatar);
    }
  });
  function finishLogin(username, avatar){
    currentUser = { username, avatar };
    saveCurrentUser();
    updateUserArea();
    closeModal(loginModal);
    loginForm.reset();
    avatarPreview.style.display = 'none';
    alert(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${username}ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!`);
  }
  cancelLoginBtn.addEventListener('click', () => {
    closeModal(loginModal);
    loginForm.reset();
    avatarPreview.style.display = 'none';
  });

  // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
  addProductForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser) {
      alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬');
      closeModal(addProductModal);
      openModal(loginModal);
      return;
    }
    const name = productNameInput.value.trim();
    const desc = productDescInput.value.trim();
    const price = parseFloat(productPriceInput.value);
    if(!name || !desc || isNaN(price) || price < 0) {
      alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
      return;
    }
    if(!productImageInput.files[0]) {
      alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„Ù…Ù†ØªØ¬');
      return;
    }
    const file = productImageInput.files[0];
    if(!file.type.startsWith('image/')){
      alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© ØµØ­ÙŠØ­Ø©');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      const newProduct = {
        id: Date.now(),
        name,
        description: desc,
        price,
        image: e.target.result,
        user: currentUser.username,
        likes: 0,
        likedBy: [],
        comments: [],
        shares: 0
      };
      products.push(newProduct);
      saveProducts();
      renderProducts();
      closeModal(addProductModal);
      addProductForm.reset();
      productImagePreview.style.display = 'none';
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
    };
    reader.readAsDataURL(file);
  });
  cancelAddProductBtn.addEventListener('click', () => {
    closeModal(addProductModal);
    addProductForm.reset();
    productImagePreview.style.display = 'none';
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  function renderProducts() {
    productsGrid.innerHTML = '';
    if(products.length === 0){
      productsGrid.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.';
      return;
    }
    products.forEach(prod => {
      const card = document.createElement('article');
      card.className = 'product-card';
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', `Ù…Ù†ØªØ¬ ${prod.name}, Ø§Ù„Ø³Ø¹Ø± ${prod.price} Ø±ÙŠØ§Ù„`);

      const img = document.createElement('img');
      img.src = prod.image;
      img.alt = `ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ ${prod.name}`;
      card.appendChild(img);

      const info = document.createElement('div');
      info.className = 'product-info';
      info.innerHTML = `
        <h3>${prod.name}</h3>
        <p>${prod.description}</p>
        <div class="price">${prod.price.toFixed(2)} Ø±ÙŠØ§Ù„</div>
      `;
      card.appendChild(info);

      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„
      const actions = document.createElement('div');
      actions.className = 'actions';

      // Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
      const likeBtn = document.createElement('button');
      likeBtn.type = 'button';
      likeBtn.innerHTML = `â¤ï¸ <span>${prod.likes}</span>`;
      if(currentUser && prod.likedBy.includes(currentUser.username)) {
        likeBtn.classList.add('active');
        likeBtn.setAttribute('aria-pressed','true');
      } else {
        likeBtn.setAttribute('aria-pressed','false');
      }
      likeBtn.title = 'Ø¥Ø¹Ø¬Ø§Ø¨';
      likeBtn.addEventListener('click', () => toggleLike(prod.id, likeBtn));
      actions.appendChild(likeBtn);

      // Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
      const commentBtn = document.createElement('button');
      commentBtn.type = 'button';
      commentBtn.textContent = `ğŸ’¬ ${prod.comments.length}`;
      commentBtn.title = 'ØªØ¹Ù„ÙŠÙ‚';
      commentBtn.addEventListener('click', () => addComment(prod.id));
      actions.appendChild(commentBtn);

      // Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
      const shareBtn = document.createElement('button');
      shareBtn.type = 'button';
      shareBtn.textContent = 'ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
      shareBtn.title = 'Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬';
      shareBtn.addEventListener('click', () => copyLink(prod.id));
      actions.appendChild(shareBtn);

      card.appendChild(actions);

      // Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªØ¹Ù„ÙŠÙ‚ÙŠÙ† Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
      if(prod.comments.length){
        const commentsDiv = document.createElement('div');
        commentsDiv.className = 'comments-list';
        const lastComments = prod.comments.slice(-2);
        lastComments.forEach(cmt => {
          const p = document.createElement('p');
          p.textContent = `${cmt.user}: ${cmt.text}`;
          commentsDiv.appendChild(p);
        });
        card.appendChild(commentsDiv);
      }

      productsGrid.appendChild(card);
    });
  }

  // ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¹Ø¬Ø§Ø¨
  function toggleLike(productId, btn) {
    if(!currentUser) {
      alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ø§Ù„Ù…Ù†ØªØ¬');
      openModal(loginModal);
      return;
    }
    const prod = products.find(p => p.id === productId);
    if(!prod) return;
    const likedIndex = prod.likedBy.indexOf(currentUser.username);
    if(likedIndex === -1){
      prod.likedBy.push(currentUser.username);
      prod.likes++;
      btn.classList.add('active');
      btn.setAttribute('aria-pressed','true');
    } else {
      prod.likedBy.splice(likedIndex, 1);
      prod.likes = Math.max(0, prod.likes - 1);
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed','false');
    }
    btn.querySelector('span').textContent = prod.likes;
    saveProducts();
  }

  // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
  function addComment(productId) {
    if(!currentUser) {
      alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚');
      openModal(loginModal);
      return;
    }
    const text = prompt('Ø£Ø¯Ø®Ù„ ØªØ¹Ù„ÙŠÙ‚Ùƒ:');
    if(!text || !text.trim()) return;
    const prod = products.find(p => p.id === productId);
    if(!prod) return;
    prod.comments.push({ user: currentUser.username, text: text.trim() });
    saveProducts();
    renderProducts();
    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚Ùƒ');
  }

  // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬
  function copyLink(productId) {
    const url = `${window.location.origin}${window.location.pathname}#product-${productId}`;
    if(navigator.clipboard){
      navigator.clipboard.writeText(url).then(() => {
        alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬!');
      }, () => {
        prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹:', url);
      });
    } else {
      prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹:', url);
    }
  }

  // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  navHome.addEventListener('click', e => {
    e.preventDefault();
    homeSection.style.display = '';
    productsSection.style.display = 'none';
    navHome.setAttribute('aria-current','page');
    navProducts.removeAttribute('aria-current');
  });
  navProducts.addEventListener('click', e => {
    e.preventDefault();
    homeSection.style.display = 'none';
    productsSection.style.display = '';
    navProducts.setAttribute('aria-current','page');
    navHome.removeAttribute('aria-current');
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£Ùˆ Escape
  [loginModal, addProductModal].forEach(modal => {
    modal.addEventListener('click', e => {
      if(e.target === modal) closeModal(modal);
    });
  });
  window.addEventListener('keydown', e => {
    if(e.key === 'Escape'){
      [loginModal, addProductModal].forEach(modal => {
        if(modal.classList.contains('active')) closeModal(modal);
      });
    }
  });

  // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„
  function init(){
    incrementVisitorCount();
    loadVisitorCount();
    loadCurrentUser();
    loadProducts();
    updateUserArea();
    renderProducts();
    // Ø§ÙØªØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    navHome.click();
  }
  init();
})();
</script>
</body>
</html>
