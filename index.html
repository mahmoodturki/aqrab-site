<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سوشيال نايت — شبكة مشاركة الصور</title>
  <style>
    :root {
      --bg: #05060a;
      --card: #0b1220;
      --muted: #9aa8bf;
      --accent: #06b6d4;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      background: linear-gradient(180deg, #020312 0%, var(--bg) 100%);
      color: #e6eef6;
      scroll-behavior: smooth;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .logo {
      font-weight: 900;
      letter-spacing: 0.6px;
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--accent), #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .container {
      max-width: 980px;
      margin: 18px auto;
      padding: 0 14px;
      padding-bottom: 80px; /* مساحة للإعلان الثابت */
    }
    
    .card {
      background: linear-gradient(180deg, var(--card), #081023);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(2,6,23,0.8);
    }
    
    /* أنماط الإعلانات */
    .ad-container {
      margin: 20px 0;
      text-align: center;
      display: flex;
      justify-content: center;
    }
    
    .ad-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    
    .ad-unit {
      margin: 10px auto;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* إعلان ثابت في الأسفل */
    #bottomAd {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(11, 18, 32, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 8px 0;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .ad-close-btn {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .ad-close-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* إعلان عائم */
    .floating-ad {
      position: fixed;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      z-index: 999;
      background: rgba(11, 18, 32, 0.9);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .floating-ad-close {
      position: absolute;
      top: 5px;
      left: 5px;
      background: transparent;
      color: var(--muted);
      border: none;
      cursor: pointer;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .floating-ad-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* إعلان بين المنشورات */
    .feed-ad {
      background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(255,255,255,0.05));
      border: 1px solid rgba(6,182,212,0.2);
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .feed-ad-label {
      font-size: 11px;
      color: var(--accent);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    /* بقية الأنماط الأصلية */
    input, textarea, button, select {
      font-size: 14px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: inherit;
      transition: all 0.2s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6,182,212,0.2);
    }
    
    button {
      cursor: pointer;
      border: 0;
      background: var(--accent);
      color: #001219;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #0891b2;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(6,182,212,0.3);
    }
    
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .col {
      flex: 1;
    }
    
    .muted {
      color: var(--muted);
    }
    
    .posts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
    }
    
    .post-card {
      border-radius: 12px;
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      position: relative;
      transition: all 0.3s;
    }
    
    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .post-image {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.3s;
      aspect-ratio: 1/1;
      object-fit: cover;
    }
    
    .post-image:hover {
      transform: scale(1.02);
    }
    
    .profile-avatar {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: linear-gradient(180deg, #0a2230, #05202a);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-weight: 700;
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    .hidden {
      display: none !important;
    }
    
    .toast {
      position: fixed;
      left: 16px;
      bottom: 120px;
      background: var(--success);
      color: #001219;
      padding: 12px 16px;
      border-radius: 8px;
      z-index: 3000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s, slideOut 0.3s 1.9s;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }
    
    .toast.error {
      background: var(--error);
    }
    
    .toast.warning {
      background: var(--warning);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .floating-ad {
        display: none; /* إخفاء الإعلان العائم في الهواتف */
      }
      
      .container {
        padding-bottom: 70px;
      }
      
      #bottomAd {
        padding: 6px 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <div class="logo">سوشيال نايت</div>
        <div class="small">شبكة مشاركة الصور — نسختك التجريبية</div>
      </div>
    </div>
    <div class="row" id="nav-right">
      <div id="nav-guest" class="row">
        <button onclick="showScreen('register')">تسجيل</button>
        <button class="secondary" onclick="showScreen('login')">دخول</button>
      </div>
      <div id="nav-user" class="row hidden">
        <span id="nav-username" class="muted"></span>
        <button class="secondary" onclick="goToProfile()">ملفي</button>
        <button class="secondary" onclick="logout()">خروج</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="screen-home" class="screen">
      <div class="card row">
        <div class="col">
          <h2>التغذية</h2>
          <div class="small">منشورات المستخدمين. عند الضغط على الصورة سيظهر معاينتها مع إعلان غير مزعج.</div>
        </div>
        <div>
          <button id="btn-new-post" onclick="showScreen('newpost')">+ نشر جديد</button>
        </div>
      </div>

      <!-- إعلان في التغذية -->
      <div class="feed-ad hidden" id="feed-ad-1">
        <div class="feed-ad-label">إعلان</div>
        <div id="feed-ad-container-1" class="ad-unit"></div>
      </div>

      <div id="feed" class="posts-grid">
        <div class="card" style="text-align: center; padding: 40px;">
          <div class="loading"></div>
          <p class="muted">جاري تحميل المنشورات...</p>
        </div>
      </div>
    </div>

    <!-- بقية الشاشات (التسجيل، الدخول، النشر، الملف الشخصي) -->
    <div id="screen-register" class="screen hidden">
      <!-- محتوى شاشة التسجيل -->
    </div>

    <div id="screen-login" class="screen hidden">
      <!-- محتوى شاشة الدخول -->
    </div>

    <div id="screen-newpost" class="screen hidden">
      <!-- محتوى شاشة النشر -->
    </div>

    <div id="screen-profile" class="screen hidden">
      <!-- محتوى شاشة الملف الشخصي -->
    </div>
  </div>

  <!-- إعلان عائم -->
  <div class="floating-ad hidden" id="floatingAd">
    <button class="floating-ad-close" onclick="closeFloatingAd()">×</button>
    <div class="small" style="margin-bottom: 8px;">إعلان</div>
    <div id="floating-ad-container" class="ad-unit"></div>
  </div>

  <!-- إعلان ثابت في الأسفل -->
  <div id="bottomAd" class="hidden">
    <button class="ad-close-btn" onclick="closeBottomAd()">×</button>
    <div id="bottom-ad-container" class="ad-unit"></div>
  </div>

  <!-- مودال الصور -->
  <div id="image-modal" class="modal hidden">
    <!-- محتوى المودال الأصلي -->
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase + TFJS + NSFWJS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nsfwjs@2.4.2/dist/nsfwjs.min.js"></script>

  <script>
    /**************************************************************************
      Firebase config - ضع إعدادات مشروعك هنا
    ***************************************************************************/
    const firebaseConfig = {
      apiKey: "your-api-key-here",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-project.appspot.com",
      messagingSenderId: "123456789",
      appId: "your-app-id"
    };

    // تهيئة Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // إعدادات التطبيق
    const App = {
      nsfwModel: null,
      currentUser: null,
      userData: {},
      posts: [],
      currentProfile: null,
      adSettings: {
        bottomAdEnabled: true,
        floatingAdEnabled: true,
        feedAdsEnabled: true,
        adRefreshInterval: 30000 // 30 ثانية
      }
    };

    // نظام الإعلانات
    const AdManager = {
      init() {
        this.loadAds();
        this.setupAdRefresh();
        this.setupAdEventListeners();
      },
      
      loadAds() {
        // تحميل الإعلان الثابت في الأسفل
        if (App.adSettings.bottomAdEnabled) {
          this.loadBottomAd();
          document.getElementById('bottomAd').classList.remove('hidden');
        }
        
        // تحميل الإعلان العائم بعد تأخير
        if (App.adSettings.floatingAdEnabled) {
          setTimeout(() => {
            this.loadFloatingAd();
            document.getElementById('floatingAd').classList.remove('hidden');
          }, 5000);
        }
        
        // تحميل إعلانات التغذية
        if (App.adSettings.feedAdsEnabled) {
          setTimeout(() => {
            this.loadFeedAd();
            document.getElementById('feed-ad-1').classList.remove('hidden');
          }, 3000);
        }
      },
      
      loadBottomAd() {
        const container = document.getElementById('bottom-ad-container');
        if (!container) return;
        
        // إنشاء iframe للإعلان
        const iframe = document.createElement('iframe');
        iframe.style.width = '320px';
        iframe.style.height = '50px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.sandbox = 'allow-scripts allow-popups allow-forms allow-same-origin';
        
        // كود الإعلان المباشر
        const adHTML = `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="referrer" content="no-referrer">
              <style>body{margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;}</style>
              <script type="text/javascript">
                atOptions = {
                  'key' : '2d5deaded3e62ebc9943db8d8b49f74e',
                  'format' : 'iframe',
                  'height' : 50,
                  'width' : 320,
                  'params' : {}
                };
              <\/script>
              <script type="text/javascript" src="//www.highperformanceformat.com/2d5deaded3e62ebc9943db8d8b49f74e/invoke.js"><\/script>
            </head>
            <body>
              <div id="ad-container"></div>
              <script>
                document.write('<scr' + 'ipt type="text/javascript" src="//www.highperformanceformat.com/2d5deaded3e62ebc9943db8d8b49f74e/invoke.js"><\/scr' + 'ipt>');
              <\/script>
            </body>
          </html>
        `;
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.srcdoc = adHTML;
      },
      
      loadFloatingAd() {
        const container = document.getElementById('floating-ad-container');
        if (!container) return;
        
        // إنشاء iframe للإعلان العائم
        const iframe = document.createElement('iframe');
        iframe.style.width = '160px';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.sandbox = 'allow-scripts allow-popups allow-forms allow-same-origin';
        
        // كود الإعلان العائم
        const adHTML = `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="referrer" content="no-referrer">
              <style>body{margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;height:100%;}</style>
            </head>
            <body>
              <script type='text/javascript' src='//pl27783662.effectivegatecpm.com/8d/f4/a9/8df4a9bd2d8c6909d8f0cfc70ea9ec02.js'><\/script>
            </body>
          </html>
        `;
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.srcdoc = adHTML;
      },
      
      loadFeedAd() {
        const container = document.getElementById('feed-ad-container-1');
        if (!container) return;
        
        // إنشاء iframe لإعلان التغذية
        const iframe = document.createElement('iframe');
        iframe.style.width = '300px';
        iframe.style.height = '250px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.sandbox = 'allow-scripts allow-popups allow-forms allow-same-origin';
        
        // كود إعلان التغذية
        const adHTML = `
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="referrer" content="no-referrer">
              <style>body{margin:0;padding:0;background:transparent;display:flex;justify-content:center;align-items:center;height:100%;}</style>
              <script type="text/javascript">
                atOptions = {
                  'key' : '3fa8b00fc8159153c0596ee9ffb026ea',
                  'format' : 'iframe',
                  'height' : 250,
                  'width' : 300,
                  'params' : {}
                };
              <\/script>
            </head>
            <body>
              <div id="ad-container"></div>
              <script>
                document.write('<scr' + 'ipt type="text/javascript" src="//www.highperformanceformat.com/3fa8b00fc8159153c0596ee9ffb026ea/invoke.js"><\/scr' + 'ipt>');
              <\/script>
            </body>
          </html>
        `;
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.srcdoc = adHTML;
      },
      
      setupAdRefresh() {
        // تحديث الإعلانات كل فترة
        setInterval(() => {
          this.refreshAds();
        }, App.adSettings.adRefreshInterval);
      },
      
      refreshAds() {
        // إعادة تحميل الإعلانات
        if (App.adSettings.bottomAdEnabled) {
          this.loadBottomAd();
        }
        
        if (App.adSettings.feedAdsEnabled) {
          this.loadFeedAd();
        }
      },
      
      setupAdEventListeners() {
        // تسجيل ظهور الإعلانات
        document.addEventListener('click', (e) => {
          if (e.target.closest('.ad-unit, .floating-ad, #bottomAd')) {
            this.recordAdInteraction('click');
          }
        });
      },
      
      recordAdInteraction(type) {
        // تسجيل تفاعلات الإعلانات في Firebase
        if (!App.currentUser) return;
        
        try {
          db.collection('adInteractions').add({
            userId: App.currentUser.uid,
            type: type,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            adPosition: type === 'click' ? 'bottom' : 'view'
          });
        } catch (error) {
          console.error('Error recording ad interaction:', error);
        }
      }
    };

    // وظائف إدارة الإعلانات
    function closeBottomAd() {
      document.getElementById('bottomAd').classList.add('hidden');
      localStorage.setItem('bottomAdClosed', 'true');
    }
    
    function closeFloatingAd() {
      document.getElementById('floatingAd').classList.add('hidden');
      localStorage.setItem('floatingAdClosed', 'true');
    }
    
    function showAd(type) {
      switch(type) {
        case 'bottom':
          document.getElementById('bottomAd').classList.remove('hidden');
          break;
        case 'floating':
          document.getElementById('floatingAd').classList.remove('hidden');
          break;
      }
    }
    
    function hideAd(type) {
      switch(type) {
        case 'bottom':
          document.getElementById('bottomAd').classList.add('hidden');
          break;
        case 'floating':
          document.getElementById('floatingAd').classList.add('hidden');
          break;
      }
    }

    // وظائف المساعدة
    function showScreen(id) { 
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
      document.getElementById('screen-' + id).classList.remove('hidden'); 
      window.scrollTo(0, 0); 
    }

    function toast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type}`;
      t.classList.remove('hidden');
      
      setTimeout(() => {
        t.classList.add('hidden');
      }, 2200);
    }

    // وظائف المصادقة والإدارة
    async function register() {
      // تطبيق وظيفة التسجيل
    }

    async function login() {
      // تطبيق وظيفة الدخول
    }

    function logout() {
      auth.signOut();
      toast('تم تسجيل الخروج');
    }

    // إدارة حالة المستخدم
    auth.onAuthStateChanged(async user => {
      const navUser = document.getElementById('nav-user');
      const navGuest = document.getElementById('nav-guest');
      
      if (user) {
        App.currentUser = user;
        navGuest.classList.add('hidden');
        navUser.classList.remove('hidden');
        
        try {
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) {
            App.userData = doc.data();
            document.getElementById('nav-username').textContent = App.userData.displayName || App.userData.username || user.email;
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
        }
        
        renderFeed();
      } else {
        App.currentUser = null;
        App.userData = {};
        navUser.classList.add('hidden');
        navGuest.classList.remove('hidden');
        document.getElementById('nav-username').textContent = '';
        renderFeed();
      }
    });

    // وظائف المنشورات
    async function createPost() {
      // تطبيق وظيفة إنشاء المنشور
    }

    async function renderFeed() {
      // تطبيق وظيفة عرض التغذية
    }

    function buildPostCard(post) {
      // تطبيق وظيفة بناء بطاقة المنشور
    }

    // تحميل نموذج NSFW
    async function loadNSFWModel() {
      try {
        App.nsfwModel = await nsfwjs.load();
        console.log('NSFW model loaded successfully');
      } catch (error) {
        console.warn('NSFW model failed to load:', error);
      }
    }

    // Router للتطبيق
    function parseHash() {
      const hash = location.hash.slice(1);
      if (!hash) return { type: 'home' };
      
      if (hash.startsWith('profile=')) {
        return { type: 'profile', id: hash.split('=')[1] };
      }
      
      return { type: 'home' };
    }

    window.addEventListener('hashchange', renderRoute);
    
    function renderRoute() {
      const route = parseHash();
      
      if (route.type === 'home') {
        showScreen('home');
        renderFeed();
      } else if (route.type === 'profile') {
        renderProfile(route.id);
      }
    }

    // تهيئة التطبيق
    async function init() {
      await loadNSFWModel();
      AdManager.init();
      renderRoute();
      
      // التحقق من تفضيلات الإعلانات السابقة
      if (localStorage.getItem('bottomAdClosed') === 'true') {
        document.getElementById('bottomAd').classList.add('hidden');
      }
      
      if (localStorage.getItem('floatingAdClosed') === 'true') {
        document.getElementById('floatingAd').classList.add('hidden');
      }
    }

    // جعل الدوال متاحة globally
    window.showScreen = showScreen;
    window.toast = toast;
    window.register = register;
    window.login = login;
    window.logout = logout;
    window.createPost = createPost;
    window.closeBottomAd = closeBottomAd;
    window.closeFloatingAd = closeFloatingAd;
    window.showAd = showAd;
    window.hideAd = hideAd;

    // بدء التطبيق
    init();
  </script>
</body>
</html>
