import React, { useEffect, useState, useRef } from "react";

// Single-file React app (Tailwind CSS classes assumed available)
// Frontend-only demo: data persisted in localStorage (users, posts, visits)
// Features:
// - Signup/login by username + profile picture
// - Create product post: name, description, multiple images
// - Like, comment, share (copy link / navigator.share), 5-star rating
// - Per-post permalink via hash (#post-{id})
// - Visit counter
// - Ranking algorithm: sorts posts by weighted interactions
// - Ad scripts placed at top and mid-feed (as requested)

const AD_SCRIPT_TOP = `
<script type="text/javascript">
	atOptions = {
		'key' : '2d5deaded3e62ebc9943db8d8b49f74e',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/2d5deaded3e62ebc9943db8d8b49f74e/invoke.js"></script>
`;

export default function App() {
  const [user, setUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [posts, setPosts] = useState([]);
  const [visitCount, setVisitCount] = useState(0);
  const [form, setForm] = useState({ title: "", desc: "", images: [] });
  const [commentText, setCommentText] = useState("");
  const fileInputRef = useRef(null);

  // Load from localStorage on mount
  useEffect(() => {
    const rawUsers = localStorage.getItem("pp_users");
    const rawPosts = localStorage.getItem("pp_posts");
    const rawVisit = localStorage.getItem("pp_visits");
    if (rawUsers) setUsers(JSON.parse(rawUsers));
    if (rawPosts) setPosts(JSON.parse(rawPosts));
    const visits = rawVisit ? parseInt(rawVisit, 10) : 0;
    const newVisits = visits + 1;
    setVisitCount(newVisits);
    localStorage.setItem("pp_visits", String(newVisits));

    // deep-linking to a post
    const hash = window.location.hash;
    if (hash.startsWith("#post-")) {
      const id = hash.replace("#post-", "");
      // scroll handled below after posts loaded
      setTimeout(() => scrollToPost(id), 300);
    }
  }, []);

  // persist users
  useEffect(() => {
    localStorage.setItem("pp_users", JSON.stringify(users));
  }, [users]);
  // persist posts
  useEffect(() => {
    localStorage.setItem("pp_posts", JSON.stringify(posts));
  }, [posts]);

  function saveUser(username, profileDataUrl) {
    const existing = users.find((u) => u.username === username);
    if (!existing) {
      const newUser = { id: Date.now().toString(), username, avatar: profileDataUrl };
      setUsers((s) => [...s, newUser]);
      setUser(newUser);
    } else {
      setUser(existing);
    }
  }

  async function handleProfileImageUpload(file) {
    const dataUrl = await readFileAsDataURL(file);
    return dataUrl;
  }

  function handleLogin(e) {
    e.preventDefault();
    const username = e.target.username.value.trim();
    const file = e.target.profile.files[0];
    if (!username) return alert("Enter a username");
    if (file) {
      handleProfileImageUpload(file).then((dataUrl) => saveUser(username, dataUrl));
    } else {
      saveUser(username, null);
    }
    e.target.reset();
  }

  function handleLogout() {
    setUser(null);
  }

  async function handleCreatePost(e) {
    e.preventDefault();
    if (!user) return alert("Please log in to post");
    if (!form.title.trim()) return alert("Product name required");
    const newPost = {
      id: Date.now().toString(),
      author: { id: user.id, username: user.username, avatar: user.avatar },
      title: form.title,
      desc: form.desc,
      images: form.images, // data URLs
      likes: [],
      comments: [],
      shares: 0,
      ratings: [],
      createdAt: new Date().toISOString(),
    };
    setPosts((s) => [newPost, ...s]);
    setForm({ title: "", desc: "", images: [] });
    fileInputRef.current.value = null;
  }

  async function handleImagesChange(e) {
    const files = Array.from(e.target.files || []);
    const urls = await Promise.all(files.map((f) => readFileAsDataURL(f)));
    setForm((s) => ({ ...s, images: [...s.images, ...urls] }));
  }

  function toggleLike(postId) {
    if (!user) return alert("Please log in to like");
    setPosts((ps) =>
      ps.map((p) => {
        if (p.id !== postId) return p;
        const liked = p.likes.includes(user.id);
        return { ...p, likes: liked ? p.likes.filter((id) => id !== user.id) : [...p.likes, user.id] };
      })
    );
  }

  function addComment(postId, text) {
    if (!user) return alert("Please log in to comment");
    if (!text.trim()) return;
    const comment = { id: Date.now().toString(), user: { id: user.id, username: user.username }, text, createdAt: new Date().toISOString() };
    setPosts((ps) => ps.map((p) => (p.id === postId ? { ...p, comments: [...p.comments, comment] } : p)));
    setCommentText("");
  }

  function sharePost(postId) {
    const url = `${window.location.origin}${window.location.pathname}#post-${postId}`;
    setPosts((ps) => ps.map((p) => (p.id === postId ? { ...p, shares: p.shares + 1 } : p)));
    if (navigator.share) {
      navigator.share({ title: "Check this product", url }).catch(() => {});
    } else {
      copyToClipboard(url);
      alert("Link copied to clipboard: " + url);
    }
  }

  function ratePost(postId, stars) {
    if (!user) return alert("Please log in to rate");
    setPosts((ps) =>
      ps.map((p) => {
        if (p.id !== postId) return p;
        const existing = p.ratings.find((r) => r.userId === user.id);
        let newRatings;
        if (existing) {
          newRatings = p.ratings.map((r) => (r.userId === user.id ? { ...r, stars } : r));
        } else {
          newRatings = [...p.ratings, { userId: user.id, stars }];
        }
        return { ...p, ratings: newRatings };
      })
    );
  }

  function computeScore(p) {
    // weighting: likes=2, comments=3, shares=1, avgRating * 2
    const likes = p.likes.length;
    const comments = p.comments.length;
    const shares = p.shares || 0;
    const avgRating = p.ratings && p.ratings.length ? p.ratings.reduce((a, b) => a + b.stars, 0) / p.ratings.length : 0;
    const score = likes * 2 + comments * 3 + shares * 1 + avgRating * 2;
    return score;
  }

  function sortedPosts() {
    return [...posts].sort((a, b) => computeScore(b) - computeScore(a) || new Date(b.createdAt) - new Date(a.createdAt));
  }

  function scrollToPost(id) {
    const el = document.getElementById(`post-${id}`);
    if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900">
      {/* Top ad */}
      <div className="w-full flex justify-center p-2 bg-white shadow-sm sticky top-0 z-40">
        <div dangerouslySetInnerHTML={{ __html: AD_SCRIPT_TOP }} />
      </div>

      <div className="max-w-4xl mx-auto p-4">
        <header className="flex items-center justify-between mb-4">
          <h1 className="text-2xl font-bold">ProdPulse</h1>
          <div className="flex items-center gap-3">
            <div className="text-sm">Visits: <strong>{visitCount}</strong></div>
            {user ? (
              <div className="flex items-center gap-2">
                {user.avatar ? (<img src={user.avatar} alt="avatar" className="w-8 h-8 rounded-full" />) : (<div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">{user.username[0]?.toUpperCase()}</div>)}
                <div className="text-sm">{user.username}</div>
                <button className="px-3 py-1 bg-red-500 text-white rounded" onClick={handleLogout}>Logout</button>
              </div>
            ) : (
              <details className="relative">
                <summary className="cursor-pointer px-3 py-1 bg-blue-600 text-white rounded">Login / Signup</summary>
                <form onSubmit={handleLogin} className="p-3 bg-white shadow-md mt-2 rounded w-72 absolute right-0">
                  <label className="text-xs">Username</label>
                  <input name="username" className="w-full p-1 border rounded text-sm" />
                  <label className="text-xs mt-2 block">Profile image (optional)</label>
                  <input name="profile" type="file" accept="image/*" className="w-full text-xs" />
                  <div className="mt-2 flex justify-end">
                    <button type="submit" className="px-3 py-1 bg-green-600 text-white rounded">Sign in</button>
                  </div>
                </form>
              </details>
            )}
          </div>
        </header>

        {/* Create post */}
        <section className="mb-6 bg-white p-4 rounded shadow-sm">
          <h2 className="font-semibold">Create Product Post</h2>
          <form onSubmit={handleCreatePost} className="space-y-2">
            <input value={form.title} onChange={(e) => setForm((s) => ({ ...s, title: e.target.value }))} placeholder="Product name" className="w-full p-2 border rounded" />
            <textarea value={form.desc} onChange={(e) => setForm((s) => ({ ...s, desc: e.target.value }))} placeholder="Product description" className="w-full p-2 border rounded" />
            <input ref={fileInputRef} multiple type="file" accept="image/*" onChange={handleImagesChange} />
            <div className="flex gap-2 overflow-x-auto py-2">
              {form.images.map((img, idx) => (
                <img key={idx} src={img} alt={`preview-${idx}`} className="w-24 h-24 object-cover rounded" />
              ))}
            </div>
            <div className="flex justify-end">
              <button className="px-4 py-2 bg-indigo-600 text-white rounded">Post</button>
            </div>
          </form>
        </section>

        {/* Posts feed */}
        <section>
          {sortedPosts().map((post, idx) => (
            <React.Fragment key={post.id}>
              {/* insert mid-ad in the middle of the feed */}
              {idx === Math.floor(sortedPosts().length / 2) && (
                <div className="w-full flex justify-center my-4">
                  <div dangerouslySetInnerHTML={{ __html: AD_SCRIPT_TOP }} />
                </div>
              )}

              <article id={`post-${post.id}`} className="mb-4 bg-white p-4 rounded shadow-sm">
                <div className="flex items-center gap-3 mb-2">
                  {post.author.avatar ? (<img src={post.author.avatar} alt="author" className="w-10 h-10 rounded-full" />) : (<div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">{post.author.username[0]?.toUpperCase()}</div>)}
                  <div>
                    <div className="font-semibold">{post.author.username}</div>
                    <div className="text-xs text-gray-500">{new Date(post.createdAt).toLocaleString()}</div>
                  </div>
                </div>
                <h3 className="font-bold text-lg">{post.title}</h3>
                <p className="my-2 text-sm whitespace-pre-line">{post.desc}</p>
                {post.images && post.images.length > 0 && (
                  <div className="grid grid-cols-2 gap-2 mb-2">
                    {post.images.map((img, i) => (<img key={i} src={img} alt={`pimg-${i}`} className="w-full h-40 object-cover rounded" />))}
                  </div>
                )}

                {/* Interaction buttons */}
                <div className="flex items-center gap-3 mt-2">
                  <button onClick={() => toggleLike(post.id)} className="px-2 py-1 rounded border">Like ({post.likes.length})</button>
                  <button onClick={() => { const c = prompt("Write a comment:"); if (c) addComment(post.id, c); }} className="px-2 py-1 rounded border">Comment ({post.comments.length})</button>
                  <button onClick={() => sharePost(post.id)} className="px-2 py-1 rounded border">Share ({post.shares})</button>
                  <button onClick={() => { const url = `${window.location.origin}${window.location.pathname}#post-${post.id}`; navigator.clipboard?.writeText(url); alert('Link copied: ' + url); }} className="px-2 py-1 rounded border">Permalink</button>

                  {/* Rating stars */}
                  <div className="ml-auto flex items-center gap-1">
                    <Stars current={post.ratings} onRate={(s) => ratePost(post.id, s)} />
                  </div>
                </div>

                {/* Comments list */}
                {post.comments.length > 0 && (
                  <div className="mt-3 border-t pt-2">
                    {post.comments.map((c) => (
                      <div key={c.id} className="text-sm py-1">
                        <strong>{c.user.username}</strong>: {c.text}
                      </div>
                    ))}
                  </div>
                )}
              </article>
            </React.Fragment>
          ))}
          {posts.length === 0 && <div className="text-center text-gray-500">No posts yet — be the first to share a product!</div>}
        </section>
      </div>
    </div>
  );
}

// Small helper components and functions
function Stars({ current, onRate }) {
  const average = current && current.length ? Math.round(current.reduce((a, b) => a + b.stars, 0) / current.length) : 0;
  return (
    <div className="flex items-center gap-1">
      {[1, 2, 3, 4, 5].map((s) => (
        <button key={s} onClick={() => onRate(s)} aria-label={`Rate ${s}`}> {s <= average ? '★' : '☆'} </button>
      ))}
      <span className="text-xs ml-2">({current?.length || 0})</span>
    </div>
  );
}

function readFileAsDataURL(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

function copyToClipboard(text) {
  if (navigator.clipboard) return navigator.clipboard.writeText(text);
  const t = document.createElement("textarea");
  t.value = text;
  document.body.appendChild(t);
  t.select();
  document.execCommand("copy");
  t.remove();
}
